<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品一覧 | ワンタッチ管理</title>
    <script src="demo-mode.js"></script>
    <script src="unified-header.js"></script>
    <script>
        // item-storage.js を直接埋め込み
        const DB_NAME = 'OneTouchDB';
        const DB_VERSION = 1;
        let db = null;

        async function openDB() {
          return new Promise((resolve, reject) => {
            if (db) return resolve(db);
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => { db = request.result; resolve(db); };
            request.onupgradeneeded = (event) => {
              const database = event.target.result;
              if (!database.objectStoreNames.contains('items')) {
                const itemStore = database.createObjectStore('items', { keyPath: 'itemId' });
                itemStore.createIndex('companyCode', 'companyCode', { unique: false });
                itemStore.createIndex('officeCode', 'officeCode', { unique: false });
              }
            };
          });
        }

        function isDemoMode() {
          try {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) return false;
            if (currentUser.companyCode === 'TAMJ' || currentUser.companyCode === 'JMAT' || currentUser.companyCode === 'SYSTEM') return true;
            if (currentUser.isDemoMode) return true;
            return false;
          } catch (e) { 
            return false; 
          }
        }

        // contractorの場合、担当会社の商品をフィルタ
        function filterItemsForUser(allItems, currentUser) {
          if (!currentUser) return [];
          if (currentUser.role === 'system_admin') return allItems;
          if (currentUser.role === 'contractor') {
            // assignedCompaniesがあればその会社の商品を表示
            var assigned = currentUser.assignedCompanies || [];
            if (assigned.length > 0) {
              return allItems.filter(function(i) { return assigned.indexOf(i.companyCode) >= 0; });
            }
            return allItems;
          }
          if (currentUser.role === 'company_admin') {
            return allItems.filter(function(i) { return i.companyCode === currentUser.companyCode; });
          }
          // office_admin, staff
          return allItems.filter(function(i) { return i.officeCode === currentUser.officeCode; });
        }

        async function initDemoItems() {
          if (!isDemoMode()) return;
          const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
          // ユーザーが変わったらdemo.itemsをリセット
          const cachedUser = sessionStorage.getItem('demo.items.user');
          const currentId = currentUser ? (currentUser.userId || currentUser.id || '') : '';
          if (cachedUser && cachedUser !== currentId) {
            sessionStorage.removeItem('demo.items');
          }
          if (sessionStorage.getItem('demo.items')) return;
          const allItems = JSON.parse(localStorage.getItem('onetouch.items') || '[]');
          const myItems = filterItemsForUser(allItems, currentUser);
          sessionStorage.setItem('demo.items', JSON.stringify(myItems));
          sessionStorage.setItem('demo.items.user', currentId);
        }

        async function getItems() {
          const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
          if (!currentUser) return [];
          if (isDemoMode()) {
            const demoItems = JSON.parse(sessionStorage.getItem('demo.items') || '[]');
            if (demoItems.length === 0) {
              const allItems = JSON.parse(localStorage.getItem('onetouch.items') || '[]');
              const myItems = filterItemsForUser(allItems, currentUser);
              if (myItems.length > 0) {
                sessionStorage.setItem('demo.items', JSON.stringify(myItems));
                return myItems;
              }
            }
            return demoItems;
          }
          // 本番モード
          const allItems = JSON.parse(localStorage.getItem('onetouch.items') || '[]');
          return filterItemsForUser(allItems, currentUser);
        }

        // 商品ナンバー生成: 管理会社コード + yymm + 4桁連番
        // 例: PN001250200001
        function generateItemNumber(assignedPartnerId) {
          // 管理会社コードを取得
          var partnerCode = '';
          if (assignedPartnerId) {
            var partners = [];
            try { partners = JSON.parse(sessionStorage.getItem('partners') || '[]'); } catch(e) {}
            try { var pl = JSON.parse(localStorage.getItem('partners') || '[]'); pl.forEach(function(p){ if(!partners.find(function(m){return m.id===p.id;})) partners.push(p); }); } catch(e) {}
            var partner = partners.find(function(p) { return p.id === assignedPartnerId; });
            if (partner && partner.partnerCode) partnerCode = partner.partnerCode;
          }
          if (!partnerCode) partnerCode = 'PN000';

          // yymm
          var now = new Date();
          var yy = String(now.getFullYear()).slice(-2);
          var mm = String(now.getMonth() + 1).padStart(2, '0');
          var prefix = partnerCode + yy + mm;

          // 既存の同プレフィックス最大連番を取得
          var maxSeq = 0;
          allItems.forEach(function(item) {
            if (item.itemId && item.itemId.startsWith(prefix)) {
              var seqPart = item.itemId.substring(prefix.length);
              var num = parseInt(seqPart, 10);
              if (!isNaN(num) && num > maxSeq) maxSeq = num;
            }
          });

          return prefix + String(maxSeq + 1).padStart(4, '0');
        }

        async function addItem(item) {
          const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
          
          if (!item.itemId) {
            item.itemId = generateItemNumber(item.assignedPartnerId);
          }
          item.createdAt = item.createdAt || new Date().toISOString();
          item.updatedAt = new Date().toISOString();
          item.companyCode = item.companyCode || currentUser.companyCode;
          item.officeCode = item.officeCode || currentUser.officeCode;
          
          if (isDemoMode()) {
            const items = JSON.parse(sessionStorage.getItem('demo.items') || '[]');
            items.push(item);
            sessionStorage.setItem('demo.items', JSON.stringify(items));
            return item;
          }
          const items = JSON.parse(localStorage.getItem('onetouch.items') || '[]');
          items.push(item);
          localStorage.setItem('onetouch.items', JSON.stringify(items));
          return item;
        }

        async function updateItem(item) {
          item.updatedAt = new Date().toISOString();
          if (isDemoMode()) {
            const items = JSON.parse(sessionStorage.getItem('demo.items') || '[]');
            const index = items.findIndex(i => i.itemId === item.itemId);
            if (index !== -1) {
              items[index] = item;
              sessionStorage.setItem('demo.items', JSON.stringify(items));
            }
            return item;
          }
          // 本番モード
          const items = JSON.parse(localStorage.getItem('onetouch.items') || '[]');
          const index = items.findIndex(i => i.itemId === item.itemId);
          if (index !== -1) {
            items[index] = item;
            localStorage.setItem('onetouch.items', JSON.stringify(items));
          }
          return item;
        }

        async function deleteItem(itemId) {
          if (isDemoMode()) {
            const items = JSON.parse(sessionStorage.getItem('demo.items') || '[]');
            const filtered = items.filter(i => i.itemId !== itemId);
            sessionStorage.setItem('demo.items', JSON.stringify(filtered));
            return true;
          }
          // 本番モード
          const items = JSON.parse(localStorage.getItem('onetouch.items') || '[]');
          const filtered = items.filter(i => i.itemId !== itemId);
          localStorage.setItem('onetouch.items', JSON.stringify(filtered));
          return true;
        }

        window.ItemStorage = { isDemoMode, initDemoItems, getItems, addItem, updateItem, deleteItem };

        // ログインチェック
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!currentUser) {
            window.location.href = 'login.html';
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html { overflow-x: hidden; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            overflow-x: hidden;
        }
        body.modal-open { overflow: hidden; position: fixed; width: 100%; }

        /* 統一ヘッダー */
        .unified-header {
            background: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .demo-badge {
            background: #1e3a5f;
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-5px);
            }
        }

        .back-btn {
            background: none;
            border: none;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .back-btn:hover {
            background: #f5f5f5;
            color: #1e293b;
        }

        .header-icon {
            font-size: 24px;
            line-height: 1;
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-info-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s;
            background: none;
            border: none;
        }

        .user-info-btn:hover {
            background: #f5f5f5;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #1e3a5f;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .user-name {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }


        /* ドロップダウンメニュー */
        .dropdown-menu {
            position: absolute;
            top: 60px;
            right: 24px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 220px;
            display: none;
            z-index: 1000;
        }

        .dropdown-menu.show {
            display: block;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
        }

        .menu-item:hover {
            background: #f5f5f5;
        }

        .menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .menu-item.user-info-detail {
            cursor: default;
            background: #fafafa;
        }

        .menu-item.user-info-detail:hover {
            background: #fafafa;
        }

        .menu-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .menu-text {
            flex: 1;
        }

        .menu-name {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        .menu-detail {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .menu-divider {
            height: 1px;
            background: #e0e0e0;
            margin: 4px 0;
        }

        .menu-item.logout {
            color: #dc2626;
        }

        .menu-item.logout:hover {
            background: #ffebee;
        }

        /* 検索・フィルターエリア */
        .header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 16px 24px;
        }

        .search-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .search-input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }

        h1 {
            font-size: 20px;
            color: #333;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #1e3a5f;
            border: none;
            color: white;
        }

        .btn-primary:hover {
            background: #2d4a7a;
        }

        .btn-secondary {
            background: white;
            border: 1px solid #e0e0e0;
            color: #666;
        }

        .btn-secondary:hover {
            background: #f5f5f5;
        }

        .btn-save {
            background: #1e3a5f;
            color: white;
        }

        .btn-save:hover {
            background: #333;
        }

        .filters {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .filter-label {
            font-size: 14px;
            color: #666;
            font-weight: 600;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: #1e3a5f;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .stats {
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
            display: flex;
            gap: 32px;
            align-items: center;
        }

        .stat-item {
            font-size: 14px;
            color: #666;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin-left: 8px;
        }

        .items-grid {
            /* テーブル表示 */
        }

        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
            overflow-x: auto;
        }

        .items-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 13px;
        }

        .items-table thead th {
            background: #f8fafc;
            padding: 10px 14px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .items-table tbody tr {
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.15s;
            cursor: pointer;
        }

        .items-table tbody tr:hover {
            background: #f1f5f9;
        }

        .items-table td {
            padding: 10px 14px;
            color: #334155;
            vertical-align: middle;
        }

        .items-table .col-name {
            font-weight: 600;
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .items-table .col-price {
            font-weight: 600;
            color: #1e293b;
            text-align: right;
            white-space: nowrap;
        }

        .items-table .col-actions {
            white-space: nowrap;
            text-align: center;
        }

        .items-table .col-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            padding: 4px 6px;
            border-radius: 4px;
            transition: background 0.15s;
        }

        .items-table .col-actions button:hover {
            background: #f0f0f0;
        }

        .badge-partner {
            display: inline-block;
            padding: 2px 6px;
            background: #e3f2fd;
            color: #1565c0;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            max-width: 140px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .badge-category {
            display: inline-block;
            padding: 2px 6px;
            background: #f1f5f9;
            color: #475569;
            border-radius: 4px;
            font-size: 11px;
        }

        /* モーダル */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .close-btn:hover {
            background: #f5f5f5;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .form-label.required::after {
            content: " *";
            color: #2563eb;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #1e3a5f;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }

        @media (max-width: 768px) {
            .unified-header {
                padding: 12px 16px;
            }
            
            .header-title {
                font-size: 16px;
            }
            
            .user-name {
                display: none; /* モバイルではアバターのみ */
            }
            
            .header-icon {
                font-size: 20px;
            }
            
            .dropdown-menu {
                right: 16px;
            }
            
            .header {
                padding: 12px 16px;
            }

            .container {
                padding: 16px;
            }

            .items-grid {
                /* テーブルはoverflow-xでスクロール対応 */
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
        }
        
        /* ページネーション */
        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            color: #333;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: #f5f5f5;
            border-color: #1e3a5f;
        }
        
        .pagination-btn.active {
            background: #1e3a5f;
            color: white;
            border-color: #1e3a5f;
            font-weight: 600;
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
    <meta name="theme-color" content="#1e3a5f">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
</head>
<body>
    <!-- 統一ヘッダー -->
    <div id="unified-header-mount" data-title="商品マスタ"></div>

    <!-- 検索・フィルターエリア -->
    <div class="header">
        <div class="search-bar">
            <input type="text" class="search-input" id="searchInput" placeholder="商品名・型番・メーカーで検索" onkeypress="if(event.key==='Enter') applyFilters()">
            <button class="btn btn-primary" onclick="applyFilters()">検索</button>
            <button class="btn btn-secondary" onclick="clearSearch()" style="margin-left: 4px;">クリア</button>
        </div>

        <div class="filters">
            <span class="filter-label" id="companyFilterLabel" style="display:none;">会社:</span>
            <select class="filter-select" id="companyFilter" onchange="onCompanyFilterChange();applyFilters();" style="display:none;">
                <option value="">全会社</option>
            </select>

            <span class="filter-label" id="officeFilterLabel" style="display:none;">事業所:</span>
            <select class="filter-select" id="officeFilter" onchange="applyFilters()" style="display:none;">
                <option value="">全事業所</option>
            </select>

            <span class="filter-label" id="partnerFilterLabel">担当管理会社:</span>
            <select class="filter-select" id="partnerFilter" onchange="applyFilters()">
                <option value="">全て</option>
            </select>

            <span class="filter-label">カテゴリー:</span>
            <select class="filter-select" id="categoryFilter" onchange="applyFilters()">
                <option value="">全カテゴリー</option>
            </select>
            
            <div style="margin-left: auto; display: flex; gap: 8px;">
                <button class="btn btn-secondary" id="btnImport" onclick="openImport()">インポート</button>
                <button class="btn btn-secondary" onclick="exportItems()">エクスポート</button>
                <button class="btn btn-primary" id="btnCreate" onclick="openCreateModal()">新規登録</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- スマホ向け案内 -->
        <div id="mobileNotice" style="display:none; background:#e8f0fe; border:1px solid #93b4f5; border-radius:10px; padding:14px 18px; margin-bottom:16px; font-size:13px; color:#1e3a5f;">
            <div style="font-weight:600; margin-bottom:4px;">この画面はPC表示に最適化されています</div>
            <div style="color:#475569;">横スクロールで全項目を確認できます。一括登録は<a href="import.html" style="color:#2563eb; font-weight:600;">インポート機能</a>が便利です。</div>
        </div>
        <script>
            if (window.innerWidth <= 768) {
                document.getElementById('mobileNotice').style.display = 'block';
            }
        </script>
        <!-- 検索前のガイド表示 -->
        <div id="searchGuide" style="text-align: center; padding: 60px 20px; color: #999;">
            <div style="margin-bottom: 16px; color: #ccc;"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div>
            <div style="font-size: 16px; font-weight: 600; color: #666; margin-bottom: 8px;">検索条件を入力してください</div>
            <div style="font-size: 13px;">商品名・型番・メーカーで検索、または担当管理会社・メーカーで絞り込みできます</div>
            <button class="btn btn-primary" onclick="showAllItems()" style="margin-top: 20px; padding: 10px 24px;">全件表示</button>
        </div>

        <!-- 検索結果エリア（初期非表示） -->
        <div id="resultsSection" style="display: none;">
            <div class="stats">
                <div class="stat-item">
                    全<span class="stat-value" id="totalCount">0</span>件
                </div>
                <div class="stat-item">
                    表示中<span class="stat-value" id="displayCount">0</span>件
                </div>
            </div>

            <div class="items-grid" id="itemsGrid"></div>
            
            <!-- ページネーション -->
            <div id="pagination" style="display: none; justify-content: center; align-items: center; gap: 8px; margin-top: 24px; padding: 20px;"></div>
        </div>
    </div>

    <!-- 新規登録/編集モーダル -->
    <div class="modal" id="itemModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">新規商品登録</h2>
                <button class="close-btn" onclick="closeModal()">×</button>
            </div>

            <form id="itemForm" onsubmit="saveItem(event)">
                <!-- 管理会社ログイン時のみ表示: 納品先会社選択 -->
                <div class="form-group" id="contractorCompanyGroup" style="display: none;">
                    <label class="form-label required">納品先会社</label>
                    <select class="form-input" id="itemDeliveryCompany">
                        <option value="">選択してください</option>
                    </select>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">
                        ※ この商品を納品する会社を選択してください
                    </div>
                </div>
                
                <div class="form-group" id="itemNumberGroup" style="display: none;">
                    <label class="form-label">商品No.</label>
                    <input type="text" class="form-input" id="itemNumberDisplay" readonly style="background: #f5f5f5; color: #666; font-family: monospace;">
                    <div style="font-size: 12px; color: #888; margin-top: 4px;">保存時に自動採番されます</div>
                </div>

                <div class="form-group">
                    <label class="form-label required">商品名</label>
                    <input type="text" class="form-input" id="itemName" required>
                </div>

                <div class="form-group">
                    <label class="form-label required">カテゴリー</label>
                    <select class="form-input" id="itemCategory" onchange="resolvePartnerFromCategory()">
                        <option value="">選択してください</option>
                        <!-- 契約テーブルから動的に生成 -->
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">担当管理会社</label>
                    <select class="form-input" id="itemAssignedPartnerSelect" onchange="document.getElementById('itemAssignedPartner').value=this.value">
                        <option value="">カテゴリ選択後に自動設定</option>
                    </select>
                    <input type="hidden" id="itemAssignedPartner" value="">
                    <div style="font-size: 12px; color: #888; margin-top: 4px;">
                        ※ カテゴリに紐づく管理会社が自動表示されます（複数の場合は選択可）
                    </div>
                </div>

                <!-- 本社管理者・システム管理者のみ: 事業所選択 -->
                <div class="form-group" id="itemOfficeGroup" style="display: none;">
                    <label class="form-label required">設置事業所</label>
                    <select class="form-input" id="itemOfficeSelect">
                        <option value="">選択してください</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">メーカー</label>
                        <input type="text" class="form-input" id="itemMaker">
                    </div>
                    <div class="form-group">
                        <label class="form-label">型番</label>
                        <input type="text" class="form-input" id="itemModel">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">単価（円）</label>
                        <input type="number" class="form-input" id="itemPrice" value="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">在庫数</label>
                        <input type="number" class="form-input" id="itemStock" value="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">単位</label>
                        <input type="text" class="form-input" id="itemUnit" value="個">
                    </div>
                    <div class="form-group">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">設置場所（推奨）</label>
                    <div style="display:flex;gap:8px;">
                        <select class="form-select" id="itemFloor" style="flex:0 0 120px;">
                            <option value="">フロア</option>
                            <option value="B1F">B1F</option>
                            <option value="1F">1F</option>
                            <option value="2F">2F</option>
                            <option value="3F">3F</option>
                            <option value="4F">4F</option>
                            <option value="5F">5F</option>
                            <option value="屋上">屋上</option>
                            <option value="共用部">共用部</option>
                            <option value="外構">外構</option>
                        </select>
                        <input type="text" class="form-input" id="itemLocation" placeholder="例：居室203、会議室A" style="flex:1;">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">備考</label>
                    <textarea class="form-textarea" id="itemDescription"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">終了日</label>
                    <input type="date" class="form-input" id="itemEndDate">
                </div>

                <input type="hidden" id="itemId">

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">キャンセル</button>
                    <button type="submit" class="btn btn-save">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let allItems = [];
        let filteredItems = [];
        let currentEditId = null;
        let currentPage = 1;
        const itemsPerPage = 50;

        // 初期化
        async function init() {
            // 統一ヘッダー初期化
            var backUrl = currentUser.role === 'contractor' ? 'contractor-dashboard.html' : 'master-top.html';
            UnifiedHeader.init({ title: '商品マスタ', backButton: true, onBack: function() { window.location.href = backUrl; } });
            await ItemStorage.initDemoItems();
            await loadItems();
            buildCategoryOptions();
            initOfficeSelect();

            // 本社管理者: インポート/新規登録を非表示、事業所フィルタを表示
            if (currentUser.role === 'company_admin') {
                var btnImport = document.getElementById('btnImport');
                var btnCreate = document.getElementById('btnCreate');
                if (btnImport) btnImport.style.display = 'none';
                if (btnCreate) btnCreate.style.display = 'none';

                // 事業所フィルタを表示＆選択肢生成
                var ofLabel = document.getElementById('officeFilterLabel');
                var ofSelect = document.getElementById('officeFilter');
                if (ofLabel) ofLabel.style.display = '';
                if (ofSelect) {
                    ofSelect.style.display = '';
                    var offices = [];
                    try { offices = JSON.parse(localStorage.getItem('offices') || '[]'); } catch(e) {}
                    offices = offices.filter(function(o) { return o.companyCode === currentUser.companyCode && o.code.indexOf('-H') === -1; });
                    ofSelect.innerHTML = '<option value="">全事業所</option>' + offices.map(function(o) {
                        return '<option value="' + o.code + '">' + o.name + '</option>';
                    }).join('');
                }
            }
        }

        // ユーザー情報表示
        function initUserInfo() {
            const userName = currentUser.userName || currentUser.name || currentUser.userId || 'ユーザー';
            const officeName = currentUser.officeName || '';
            
            // ヘッダーのユーザー名
            document.getElementById('userName').textContent = userName;
            
            // アバター（名前の最初の1文字）
            document.getElementById('userAvatar').textContent = userName.charAt(0);
            
            // メニュー内のユーザー情報
            document.getElementById('menuUserName').textContent = userName;
            document.getElementById('menuUserDetail').textContent = officeName || currentUser.companyName || '-';
        }
        
        // ユーザーメニューのトグル
        function toggleUserMenu() {
            const menu = document.getElementById('dropdownMenu');
            menu.classList.toggle('show');
        }
        
        // メニュー外をクリックしたら閉じる
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('dropdownMenu');
            const userBtn = document.querySelector('.user-info-btn');
            
            if (!menu.contains(event.target) && !userBtn.contains(event.target)) {
                menu.classList.remove('show');
            }
        });

        // 管理会社一覧を読み込む
        // ロール別事業所選択の初期化
        function initOfficeSelect() {
            var group = document.getElementById('itemOfficeGroup');
            var select = document.getElementById('itemOfficeSelect');
            if (!group || !select) return;

            // スタッフ・事業所管理者・管理会社は不要（自分の事業所が自動適用）
            if (currentUser.role === 'staff' || currentUser.role === 'office_admin' || currentUser.role === 'contractor') {
                group.style.display = 'none';
                return;
            }

            // 本社管理者・システム管理者は事業所選択を表示
            group.style.display = 'block';
            var offices = [];
            try { offices = JSON.parse(sessionStorage.getItem('offices') || '[]'); } catch(e) {}
            try { var ol = JSON.parse(localStorage.getItem('offices') || '[]'); ol.forEach(function(o) { if (!offices.find(function(x) { return x.code === o.code; })) offices.push(o); }); } catch(e) {}

            // 本社管理者は自社の事業所のみ
            if (currentUser.role === 'company_admin') {
                offices = offices.filter(function(o) { return o.companyCode === currentUser.companyCode; });
            }

            select.innerHTML = '<option value="">選択してください</option>' + offices.map(function(o) {
                return '<option value="' + o.code + '">' + o.name + '</option>';
            }).join('');
        }

        // カテゴリプルダウンを契約テーブルから動的生成
        function buildCategoryOptions() {
            var catSelect = document.getElementById('itemCategory');
            if (!catSelect) return;
            var companyCode = currentUser.companyCode || '';
            var userRole = currentUser.role || '';
            
            // 契約テーブルからカテゴリを取得
            var contracts = [];
            try { contracts = JSON.parse(sessionStorage.getItem('onetouch.contracts') || '[]'); } catch(e) {}
            try { var cl = JSON.parse(localStorage.getItem('onetouch.contracts') || '[]'); cl.forEach(function(c){ if(!contracts.find(function(x){return x.id===c.id;})) contracts.push(c); }); } catch(e) {}
            
            var categories = [];
            contracts.forEach(function(c) {
                if (c.status !== 'active') return;
                
                // ロール別フィルタ
                var match = false;
                if (userRole === 'system_admin') {
                    match = true; // 全契約
                } else if (userRole === 'contractor') {
                    // 管理会社: 自分のpartnerIdに紐づく契約
                    match = (c.partnerId === currentUser.partnerId || c.partnerId === currentUser.partnerCode);
                } else {
                    // スタッフ・事業所管理者・本社管理者: 自社の契約
                    match = (!companyCode || c.companyCode === companyCode);
                }
                
                if (match) {
                    (c.categories || []).forEach(function(cat) {
                        if (categories.indexOf(cat) < 0) categories.push(cat);
                    });
                }
            });
            
            // フォールバック: 契約がない場合は全カテゴリ表示
            if (categories.length === 0) {
                categories = (typeof window.getAllCategories === 'function') ? window.getAllCategories(companyCode || 'TAMJ') : ['建物・外','部屋・共用部','介護医療備品','厨房','ネットワーク','浴室','福祉用具','その他'];
            }

            // ON/OFF設定を反映（ONカテゴリーのみ選択可能）
            var enabledCats = (typeof window.getEnabledCategories === 'function') ? window.getEnabledCategories(companyCode || 'TAMJ') : categories;
            
            catSelect.innerHTML = '<option value="">選択してください</option>' + categories.map(function(cat) {
                var isEnabled = enabledCats.indexOf(cat) !== -1;
                if (isEnabled) {
                    return '<option value="' + cat + '">' + cat + '</option>';
                } else {
                    return '<option value="' + cat + '" disabled style="color:#bbb;">' + cat + '（OFF）</option>';
                }
            }).join('');
        }

        // カテゴリ選択時に契約テーブルから担当管理会社を解決
        function resolvePartnerFromCategory() {
            var category = document.getElementById('itemCategory').value;
            var partnerSelect = document.getElementById('itemAssignedPartnerSelect');
            var hidden = document.getElementById('itemAssignedPartner');
            
            if (!category) {
                partnerSelect.innerHTML = '<option value="">カテゴリ選択後に自動設定</option>';
                hidden.value = '';
                return;
            }
            
            var companyCode = currentUser.companyCode || '';
            
            // 契約テーブルから該当カテゴリの管理会社を検索
            var contracts = [];
            try { contracts = JSON.parse(sessionStorage.getItem('onetouch.contracts') || '[]'); } catch(e) {}
            try { var cl = JSON.parse(localStorage.getItem('onetouch.contracts') || '[]'); cl.forEach(function(c){ if(!contracts.find(function(x){return x.id===c.id;})) contracts.push(c); }); } catch(e) {}
            
            var partners = [];
            try { partners = JSON.parse(sessionStorage.getItem('partners') || '[]'); } catch(e) {}
            try { var pl = JSON.parse(localStorage.getItem('partners') || '[]'); pl.forEach(function(p){ if(!partners.find(function(x){return x.id===p.id || x.partnerCode===p.partnerCode;})) partners.push(p); }); } catch(e) {}
            
            // 該当カテゴリを持つ有効な契約の管理会社を取得
            var userRole = currentUser.role || '';
            var matchedPartners = [];
            contracts.forEach(function(c) {
                if (c.status !== 'active') return;
                if ((c.categories || []).indexOf(category) < 0) return;
                
                // ロール別フィルタ
                var match = false;
                if (userRole === 'system_admin') {
                    match = true;
                } else if (userRole === 'contractor') {
                    match = (c.partnerId === currentUser.partnerId || c.partnerId === currentUser.partnerCode);
                } else {
                    match = (!companyCode || c.companyCode === companyCode);
                }
                
                if (match) {
                    var p = partners.find(function(x) { return x.id === c.partnerId || x.partnerCode === c.partnerId; });
                    var name = p ? p.name : c.partnerId;
                    if (!matchedPartners.find(function(m) { return m.id === c.partnerId; })) {
                        matchedPartners.push({ id: c.partnerId, name: name });
                    }
                }
            });
            
            if (matchedPartners.length === 0) {
                // フォールバック: resolvePartner関数を使用
                if (typeof resolvePartner === 'function') {
                    var result = resolvePartner({ category: category, companyCode: companyCode }, currentUser.officeCode || '');
                    if (result.partnerId) {
                        matchedPartners.push({ id: result.partnerId, name: result.partnerName || result.partnerId });
                    }
                }
            }
            
            if (matchedPartners.length === 0) {
                partnerSelect.innerHTML = '<option value="">（未割当 — 契約設定をご確認ください）</option>';
                hidden.value = '';
            } else if (matchedPartners.length === 1) {
                partnerSelect.innerHTML = '<option value="' + matchedPartners[0].id + '">' + matchedPartners[0].name + '</option>';
                hidden.value = matchedPartners[0].id;
            } else {
                partnerSelect.innerHTML = '<option value="">管理会社を選択してください</option>' + matchedPartners.map(function(p) {
                    return '<option value="' + p.id + '">' + p.name + '</option>';
                }).join('');
                hidden.value = '';
            }
        }

        function loadPartners() {
            
            try {
                // 管理会社ログインの場合
                if (currentUser.role === 'contractor') {
                    const currentContractor = JSON.parse(sessionStorage.getItem('currentContractor'));
                    
                    if (!currentContractor) {
                        console.error('[loadPartners] 管理会社情報が見つかりません');
                        return;
                    }
                    
                    const partnerDisplayName = currentContractor.companyName || currentContractor.name;
                    const select = document.getElementById('itemAssignedPartner');
                    select.innerHTML = `<option value="${currentContractor.id}" data-partner-name="${partnerDisplayName}" selected>${partnerDisplayName}</option>`;
                    select.disabled = true; // 管理会社は変更できない
                    
                    return;
                }
                
                let partners = [];
                try { partners = JSON.parse(sessionStorage.getItem('partners') || '[]'); } catch(e) {}
                let partnersLocal = [];
                try { partnersLocal = JSON.parse(localStorage.getItem('partners') || '[]'); } catch(e) {}
                partnersLocal.forEach(p => { if (!partners.find(m => m.id === p.id)) partners.push(p); });
                
                // DEMOモードで管理会社データが空の場合、デフォルトデータを使用
                if (partners.length === 0 && isDemoMode()) {
                    partners = [
                        {
                            id: 'PN001',
                            name: '東京設備工業株式会社',
                            partnerCode: 'PN001',
                            categories: ['部屋・共用部', '厨房', '介護医療備品'],
                            assignedCompanies: ['TAMJ'],
                            status: 'active'
                        },
                        {
                            id: 'PN002',
                            name: '関東水道サービス',
                            partnerCode: 'PN002',
                            categories: ['建物・外'],
                            assignedCompanies: ['TAMJ'],
                            status: 'active'
                        },
                        {
                            id: 'PN003',
                            name: '日本電気工事',
                            partnerCode: 'PN003',
                            categories: ['ネットワーク'],
                            assignedCompanies: ['TAMJ'],
                            status: 'active'
                        }
                    ];
                }
                
                
                // 現在の会社に紐付いている管理会社のみフィルター（契約テーブルベース）
                var contracts = [];
                try { contracts = JSON.parse(sessionStorage.getItem('onetouch.contracts') || '[]'); } catch(e) {}
                try { var cl = JSON.parse(localStorage.getItem('onetouch.contracts') || '[]'); cl.forEach(function(c) { if (!contracts.find(function(x) { return x.id === c.id; })) contracts.push(c); }); } catch(e) {}
                
                const contractedPartnerIds = contracts
                    .filter(c => c.status === 'active' && c.companyCode === currentUser.companyCode)
                    .map(c => c.partnerId);
                
                const filteredPartners = partners.filter(p => {
                    const pid = p.id || p.partnerCode;
                    const isContracted = contractedPartnerIds.indexOf(pid) !== -1;
                    // 後方互換: 契約テーブルにない場合はassignedCompaniesも参照
                    const companies = p.assignedCompanies || [];
                    const isAssigned = Array.isArray(companies) && companies.includes(currentUser.companyCode);
                    const sameCompany = p.companyCode === currentUser.companyCode;
                    const isActive = p.status !== 'inactive';
                    return (isContracted || isAssigned || sameCompany) && isActive;
                });
                
                
                // セレクトボックスに追加
                const select = document.getElementById('itemAssignedPartner');
                select.innerHTML = '<option value="">選択してください</option>';
                
                filteredPartners.forEach(partner => {
                    const option = document.createElement('option');
                    option.value = partner.id;
                    option.textContent = partner.name;
                    option.dataset.partnerName = partner.name;
                    select.appendChild(option);
                });
                
            } catch (e) {
                console.error('[loadPartners] エラー:', e);
            }
        }

        // 商品読み込み
        async function loadItems(showResults = false) {
            
            try {
                allItems = await ItemStorage.getItems();
                
                // DEMOモード（TAMJ）で商品が0件の場合、ダミー商品を自動生成
                if (allItems.length === 0 && isDemoMode()) {
                    const demoItems = [
                        { itemId:'ITEM-DEMO-001', companyCode:'TAMJ', officeCode:'TAMJ-J0001', name:'介護ベッド 101号室', maker:'パラマウントベッド', model:'KQ-60330', category:'部屋・共用部', assignedPartnerId:'PN001', assignedPartnerName:'東京設備工業株式会社', unit:'台', price:280000, stock:1, description:'電動3モーター', floor:'1F', location:'居室101', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() },
                        { itemId:'ITEM-DEMO-002', companyCode:'TAMJ', officeCode:'TAMJ-J0001', name:'食堂テーブル A', maker:'コクヨ', model:'MT-V159', category:'部屋・共用部', assignedPartnerId:'PN001', assignedPartnerName:'東京設備工業株式会社', unit:'台', price:45000, stock:1, description:'6人掛け', floor:'1F', location:'食堂', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() },
                        { itemId:'ITEM-DEMO-003', companyCode:'TAMJ', officeCode:'TAMJ-J0001', name:'エアコン 1号機', maker:'ダイキン', model:'AN22XRS-W', category:'部屋・共用部', assignedPartnerId:'PN001', assignedPartnerName:'東京設備工業株式会社', unit:'台', price:150000, stock:1, description:'2F 会議室に設置', floor:'2F', location:'会議室', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() },
                        { itemId:'ITEM-DEMO-004', companyCode:'TAMJ', officeCode:'TAMJ-J0001', name:'照明器具 LED-01', maker:'パナソニック', model:'LGB51210', category:'部屋・共用部', assignedPartnerId:'PN003', assignedPartnerName:'日本電気工事', unit:'個', price:12000, stock:10, description:'各フロア共通', floor:'共用部', location:'各フロア', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() },
                        { itemId:'ITEM-DEMO-005', companyCode:'TAMJ', officeCode:'TAMJ-J0001', name:'洗濯機 2F', maker:'パナソニック', model:'NA-FA120V5', category:'部屋・共用部', assignedPartnerId:'PN001', assignedPartnerName:'東京設備工業株式会社', unit:'台', price:180000, stock:1, description:'', floor:'2F', location:'洗濯室', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() },
                        { itemId:'ITEM-DEMO-006', companyCode:'TAMJ', officeCode:'TAMJ-J0001', name:'Wi-Fiルーター 1F', maker:'バッファロー', model:'WSR-5400AX6S', category:'ネットワーク', assignedPartnerId:'PN003', assignedPartnerName:'日本電気工事', unit:'台', price:15000, stock:1, description:'', floor:'1F', location:'事務室', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() },
                        { itemId:'ITEM-DEMO-007', companyCode:'TAMJ', officeCode:'TAMJ-J0001', name:'ナースコール受信機', maker:'アイホン', model:'NFX-SER', category:'ネットワーク', assignedPartnerId:'PN003', assignedPartnerName:'日本電気工事', unit:'台', price:350000, stock:1, description:'', floor:'1F', location:'スタッフステーション', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() },
                        { itemId:'ITEM-DEMO-008', companyCode:'TAMJ', officeCode:'TAMJ-J0001', name:'業務用冷蔵庫', maker:'ホシザキ', model:'HR-120AT', category:'厨房', assignedPartnerId:'PN001', assignedPartnerName:'東京設備工業株式会社', unit:'台', price:350000, stock:1, description:'', floor:'1F', location:'厨房', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() },
                        { itemId:'ITEM-DEMO-009', companyCode:'TAMJ', officeCode:'TAMJ-J0001', name:'食器洗浄機', maker:'ホシザキ', model:'JWE-400TUB', category:'厨房', assignedPartnerId:'PN001', assignedPartnerName:'東京設備工業株式会社', unit:'台', price:280000, stock:1, description:'', floor:'1F', location:'厨房', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() },
                        { itemId:'ITEM-DEMO-010', companyCode:'TAMJ', officeCode:'TAMJ-J0001', name:'機械浴槽', maker:'酒井医療', model:'ヌクティ', category:'建物・外', assignedPartnerId:'PN002', assignedPartnerName:'関東水道サービス', unit:'台', price:2500000, stock:1, description:'リフト式', floor:'1F', location:'浴室', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() },
                        { itemId:'ITEM-DEMO-011', companyCode:'TAMJ', officeCode:'TAMJ-J0001', name:'給湯器 A', maker:'リンナイ', model:'RUX-A1615W-E', category:'建物・外', assignedPartnerId:'PN002', assignedPartnerName:'関東水道サービス', unit:'台', price:80000, stock:1, description:'', floor:'1F', location:'機械室', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() },
                        { itemId:'ITEM-DEMO-012', companyCode:'TAMJ', officeCode:'TAMJ-J0001', name:'車椅子 標準型', maker:'カワムラサイクル', model:'KA822-40B', category:'介護医療備品', assignedPartnerId:'PN001', assignedPartnerName:'東京設備工業株式会社', unit:'台', price:45000, stock:5, description:'', floor:'共用部', location:'倉庫', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() },
                        { itemId:'ITEM-DEMO-013', companyCode:'TAMJ', officeCode:'TAMJ-J0001', name:'吸引器', maker:'新鋭工業', model:'QS-101', category:'介護医療備品', assignedPartnerId:'PN001', assignedPartnerName:'東京設備工業株式会社', unit:'台', price:38000, stock:2, description:'', floor:'2F', location:'スタッフステーション', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() },
                        { itemId:'ITEM-DEMO-014', companyCode:'TAMJ', officeCode:'TAMJ-J0001', name:'トイレ 1F', maker:'TOTO', model:'CES9788F', category:'建物・外', assignedPartnerId:'PN002', assignedPartnerName:'関東水道サービス', unit:'台', price:180000, stock:1, description:'', floor:'1F', location:'男子トイレ', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() },
                        { itemId:'ITEM-DEMO-015', companyCode:'TAMJ', officeCode:'TAMJ-J0001', name:'手洗い場 2F', maker:'LIXIL', model:'L-A74TA', category:'建物・外', assignedPartnerId:'PN002', assignedPartnerName:'関東水道サービス', unit:'台', price:25000, stock:1, description:'', floor:'2F', location:'廊下', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() },
                        { itemId:'ITEM-DEMO-016', companyCode:'TAMJ', officeCode:'TAMJ-J0001', name:'ガスコンロ 厨房', maker:'リンナイ', model:'RSW-F404C', category:'建物・外', assignedPartnerId:'PN002', assignedPartnerName:'関東水道サービス', unit:'台', price:120000, stock:1, description:'', floor:'1F', location:'厨房', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() },
                        { itemId:'ITEM-DEMO-017', companyCode:'TAMJ', officeCode:'TAMJ-J0001', name:'エレベーター', maker:'三菱電機', model:'AXIEZ', category:'建物・外', assignedPartnerId:'PN003', assignedPartnerName:'日本電気工事', unit:'基', price:5000000, stock:1, description:'本館', floor:'共用部', location:'本館', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() },
                        { itemId:'ITEM-DEMO-018', companyCode:'TAMJ', officeCode:'TAMJ-J0001', name:'階段昇降機', maker:'シンドラー', model:'S200', category:'建物・外', assignedPartnerId:'PN003', assignedPartnerName:'日本電気工事', unit:'台', price:800000, stock:1, description:'', floor:'共用部', location:'北棟階段', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString() }
                    ];
                    
                    // sessionStorageに保存
                    const storageKey = isDemoMode() ? 'demo.items' : 'items';
                    const storage = isDemoMode() ? sessionStorage : localStorage;
                    storage.setItem(storageKey, JSON.stringify(demoItems));
                    
                    allItems = demoItems;
                }
                
                allItems.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                // 管理会社ログインの場合: 自分の担当商品だけに絞る
                if (currentUser.role === 'contractor') {
                    const currentContractor = JSON.parse(sessionStorage.getItem('currentContractor') || '{}');
                    if (currentContractor && currentContractor.id) {
                        allItems = allItems.filter(function(item) {
                            return item.assignedPartnerId === currentContractor.id || 
                                   item.assignedPartnerId === currentContractor.partnerCode;
                        });
                    }
                    // 担当管理会社フィルタを非表示（自分の担当分しかないので不要）
                    var pfl = document.getElementById('partnerFilterLabel');
                    var pf = document.getElementById('partnerFilter');
                    if (pfl) pfl.style.display = 'none';
                    if (pf) pf.style.display = 'none';
                    // 管理会社用: 会社フィルタ・事業所フィルタを表示
                    var cfl = document.getElementById('companyFilterLabel');
                    var cf = document.getElementById('companyFilter');
                    if (cfl) cfl.style.display = '';
                    if (cf) cf.style.display = '';
                    var ofl = document.getElementById('officeFilterLabel');
                    var of2 = document.getElementById('officeFilter');
                    if (ofl) ofl.style.display = '';
                    if (of2) of2.style.display = '';
                    // 会社リストを生成（担当会社から）
                    var companies = [...new Set(allItems.map(i => i.companyCode).filter(Boolean))];
                    cf.innerHTML = '<option value="">全会社</option>' + companies.map(function(code) {
                        var name = allItems.find(i => i.companyCode === code);
                        return '<option value="' + code + '">' + code + '</option>';
                    }).join('');
                    onCompanyFilterChange();
                }
                
                updateFilters();
                if (showResults) {
                    applyFilters();
                }
            } catch (e) {
                console.error('商品読み込みエラー:', e);
                alert('商品の読み込みに失敗しました');
            }
        }

        // フィルター更新
        function updateFilters() {
            // 担当管理会社
            const partners = [...new Set(allItems.map(item => item.assignedPartnerName).filter(Boolean))];
            const partnerFilter = document.getElementById('partnerFilter');
            partnerFilter.innerHTML = '<option value="">全て</option>' + 
                partners.map(p => `<option value="${p}">${p}</option>`).join('');

            // カテゴリーフィルター（ON/OFF連動）
            const catFilter = document.getElementById('categoryFilter');
            if (catFilter) {
                const companyCode = (currentUser && currentUser.companyCode) ? currentUser.companyCode : 'TAMJ';
                const allCats = (typeof window.getAllCategories === 'function') ? window.getAllCategories(companyCode) : window.SYSTEM_CATEGORIES;
                const enabledCats = (typeof window.getEnabledCategories === 'function') ? window.getEnabledCategories(companyCode) : allCats;
                const disabledCats = (typeof window.getDisabledCategories === 'function') ? window.getDisabledCategories(companyCode) : [];
                let opts = '<option value="">全カテゴリー</option>';
                enabledCats.forEach(function(c) {
                    opts += '<option value="' + c + '">' + c + '</option>';
                });
                disabledCats.forEach(function(c) {
                    opts += '<option value="' + c + '" disabled style="color:#bbb;">' + c + '（OFF）</option>';
                });
                catFilter.innerHTML = opts;
            }
        }

        // 会社フィルタ変更時に事業所リストを連動
        function onCompanyFilterChange() {
            var compVal = document.getElementById('companyFilter').value;
            var offSel = document.getElementById('officeFilter');
            var offices = [...new Set(allItems.filter(function(i) {
                return !compVal || i.companyCode === compVal;
            }).map(function(i) {
                return JSON.stringify({code: i.officeCode, name: i.officeName});
            }))].map(function(s) { return JSON.parse(s); });
            offSel.innerHTML = '<option value="">全事業所</option>' + offices.map(function(o) {
                return '<option value="' + o.code + '">' + (o.name || o.code) + '</option>';
            }).join('');
        }

        // フィルター適用
        // 全角→半角変換＋小文字化
        function normalizeSearch(str) {
            if (!str) return '';
            return str.replace(/[Ａ-Ｚａ-ｚ０-９]/g, function(s) {
                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            }).replace(/[\u3000]/g, ' ').toLowerCase();
        }

        function applyFilters() {
            const searchQuery = normalizeSearch(document.getElementById('searchInput').value);
            const partnerFilter = document.getElementById('partnerFilter').value;
            const officeFilterEl = document.getElementById('officeFilter');
            const officeFilter = officeFilterEl ? officeFilterEl.value : '';
            const companyFilterEl = document.getElementById('companyFilter');
            const companyFilter = companyFilterEl ? companyFilterEl.value : '';
            const categoryFilterEl = document.getElementById('categoryFilter');
            const categoryFilter = categoryFilterEl ? categoryFilterEl.value : '';

            filteredItems = allItems.filter(item => {
                // 管理会社ログインの場合: 自社が担当している商品のみ表示
                if (currentUser.role === 'contractor') {
                    const currentContractor = JSON.parse(sessionStorage.getItem('currentContractor'));
                    if (currentContractor && item.assignedPartnerId !== currentContractor.id) {
                        return false;
                    }
                }
                
                // 検索（大文字小文字＋全角半角を無視）
                const matchSearch = !searchQuery || 
                    normalizeSearch(item.name).includes(searchQuery) ||
                    normalizeSearch(item.model).includes(searchQuery) ||
                    normalizeSearch(item.maker).includes(searchQuery) ||
                    normalizeSearch(item.itemId).includes(searchQuery) ||
                    normalizeSearch(item.category).includes(searchQuery) ||
                    normalizeSearch(item.floor).includes(searchQuery) ||
                    normalizeSearch(item.location).includes(searchQuery);

                // 会社フィルタ
                const matchCompany = !companyFilter || item.companyCode === companyFilter;

                // 事業所フィルタ
                const matchOffice = !officeFilter || item.officeCode === officeFilter;

                // 担当管理会社
                const matchPartner = !partnerFilter || item.assignedPartnerName === partnerFilter;

                // カテゴリーフィルタ
                const matchCategory = !categoryFilter || item.category === categoryFilter;

                return matchSearch && matchCompany && matchOffice && matchPartner && matchCategory;
            });

            // 検索・フィルタ時はページを1に戻す
            currentPage = 1;
            // 検索結果エリアを表示、ガイドを非表示
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('searchGuide').style.display = 'none';
            renderItems();
        }

        // 全件表示
        function showAllItems() {
            document.getElementById('searchInput').value = '';
            document.getElementById('partnerFilter').value = '';
            var catF = document.getElementById('categoryFilter'); if (catF) catF.value = '';
            var cf = document.getElementById('companyFilter'); if (cf) cf.value = '';
            var of2 = document.getElementById('officeFilter'); if (of2) of2.value = '';
            if (typeof onCompanyFilterChange === 'function') onCompanyFilterChange();
            applyFilters();
        }

        // 検索条件クリア（初期状態に戻す）
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('partnerFilter').value = '';
            var catF = document.getElementById('categoryFilter'); if (catF) catF.value = '';
            var cf = document.getElementById('companyFilter'); if (cf) cf.value = '';
            var ofSelect = document.getElementById('officeFilter');
            if (ofSelect) ofSelect.value = '';
            if (typeof onCompanyFilterChange === 'function') onCompanyFilterChange();
            
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('searchGuide').style.display = 'block';
        }

        // 商品表示
        function renderItems() {
            const grid = document.getElementById('itemsGrid');
            const totalCount = document.getElementById('totalCount');
            const displayCount = document.getElementById('displayCount');

            totalCount.textContent = allItems.length;
            displayCount.textContent = filteredItems.length;

            if (filteredItems.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">商品がありません</div>';
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            // ページネーション計算
            const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageItems = filteredItems.slice(startIndex, endIndex);


            grid.innerHTML = `
            <div class="table-container">
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>商品No.</th>
                            <th>商品名</th>
                            <th>担当管理会社</th>
                            <th>カテゴリー</th>
                            <th>設置場所</th>
                            <th>在庫</th>
                            <th>単価</th>
                            <th>編集</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pageItems.map(item => `
                        <tr style="${item.endDate ? 'background: #f0f0f0; color: #aaa;' : ''}">
                            <td style="font-family: monospace; font-size: 12px; color: ${item.endDate ? '#ccc' : '#888'};">${item.itemId || '-'}</td>
                            <td class="col-name" title="${item.name || ''}">${item.name || '-'}${item.endDate ? ' <span style="font-size:11px;color:#bbb;">（終了）</span>' : ''}</td>
                            <td>${item.assignedPartnerName ? `<span class="badge-partner" title="${item.assignedPartnerName}" style="${item.endDate ? 'opacity:0.5;' : ''}">${item.assignedPartnerName}</span>` : '-'}</td>
                            <td style="font-size:12px;color:#666;">${item.category || '-'}</td>
                            <td style="font-size:12px;color:#666;">${[item.floor, item.location].filter(Boolean).join(' ') || '-'}</td>
                            <td>${item.stock || 0} ${item.unit || '個'}</td>
                            <td class="col-price">¥${(item.price || 0).toLocaleString()}</td>
                            <td class="col-actions">
                                <button onclick="editItem('${item.itemId}')" title="編集">編集</button>
                            </td>
                        </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>`;
            
            // ページネーション表示を更新
            renderPagination(totalPages);
        }
        
        // ページネーション表示
        function renderPagination(totalPages) {
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            
            let html = '';
            
            // 前へボタン
            html += `<button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">← 前へ</button>`;
            
            // ページ番号
            html += '<div style="display: flex; gap: 4px;">';
            
            // 最初のページ
            if (currentPage > 3) {
                html += `<button class="pagination-btn" onclick="changePage(1)">1</button>`;
                if (currentPage > 4) {
                    html += '<span style="padding: 8px;">...</span>';
                }
            }
            
            // 現在のページ周辺
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }
            
            // 最後のページ
            if (currentPage < totalPages - 2) {
                if (currentPage < totalPages - 3) {
                    html += '<span style="padding: 8px;">...</span>';
                }
                html += `<button class="pagination-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
            }
            
            html += '</div>';
            
            // 次へボタン
            html += `<button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">次へ →</button>`;
            
            pagination.innerHTML = html;
        }
        
        // ページ変更
        function changePage(page) {
            currentPage = page;
            renderItems();
            // ページトップにスクロール
            document.querySelector('.header').scrollIntoView({ behavior: 'smooth' });
        }

        // 日付フォーマット
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
        }

        // 検索
        // モーダル開く（新規）
        function openCreateModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = '新規商品登録';
            document.getElementById('itemForm').reset();
            document.getElementById('itemId').value = '';
            document.getElementById('itemNumberGroup').style.display = 'none';
            // 担当管理会社をリセット
            document.getElementById('itemAssignedPartner').value = '';
            document.getElementById('itemAssignedPartnerSelect').innerHTML = '<option value="">カテゴリ選択後に自動設定</option>';
            
            // 管理会社ログインの場合、納品先会社を自動セット
            if (currentUser.role === 'contractor') {
                const currentContractor = JSON.parse(sessionStorage.getItem('currentContractor'));
                const companyGroup = document.getElementById('contractorCompanyGroup');
                const select = document.getElementById('itemDeliveryCompany');
                select.innerHTML = '<option value="">選択してください</option>';
                
                if (currentContractor && currentContractor.assignedCompanies) {
                    // 会社マスタを取得（DEMOモード対応）
                    let companies = [];
                    try { companies = JSON.parse(sessionStorage.getItem('demo.companies') || '[]'); } catch(e) {}
                    try { var cl = JSON.parse(sessionStorage.getItem('companies') || '[]'); cl.forEach(function(c){ if(!companies.find(function(m){return (m.companyCode||m.code)===( c.companyCode||c.code);})) companies.push(c); }); } catch(e) {}
                    try { var cl2 = JSON.parse(localStorage.getItem('companies') || '[]'); cl2.forEach(function(c){ if(!companies.find(function(m){return (m.companyCode||m.code)===(c.companyCode||c.code);})) companies.push(c); }); } catch(e) {}
                    
                    currentContractor.assignedCompanies.forEach(companyCode => {
                        const company = companies.find(c => (c.companyCode||c.code) === companyCode);
                        const companyName = company ? (company.companyName||company.name) : companyCode;
                        
                        const option = document.createElement('option');
                        option.value = companyCode;
                        option.textContent = companyName;
                        select.appendChild(option);
                    });
                    
                    // 1社のみなら自動選択して非表示
                    if (currentContractor.assignedCompanies.length === 1) {
                        select.value = currentContractor.assignedCompanies[0];
                        companyGroup.style.display = 'none';
                    } else {
                        companyGroup.style.display = 'block';
                    }
                } else {
                    companyGroup.style.display = 'none';
                }
            } else {
                document.getElementById('contractorCompanyGroup').style.display = 'none';
            }
            
            document.body._scrollY = window.scrollY;
            document.body.style.top = (-window.scrollY) + 'px';
            document.body.classList.add('modal-open');
            document.getElementById('itemModal').classList.add('show');
            buildCategoryOptions();
            initOfficeSelect();
        }

        // モーダル開く（編集）
        function editItem(itemId) {
            const item = allItems.find(i => i.itemId === itemId);
            if (!item) return;
            
            currentEditId = itemId;
            document.getElementById('modalTitle').textContent = '商品編集';
            document.getElementById('itemId').value = item.itemId;
            document.getElementById('itemNumberGroup').style.display = 'block';
            document.getElementById('itemNumberDisplay').value = item.itemId || '';
            document.getElementById('itemName').value = item.name || '';
            document.getElementById('itemMaker').value = item.maker || '';
            document.getElementById('itemModel').value = item.model || '';
            document.getElementById('itemCategory').value = item.category || '';
            // 担当管理会社は契約ベースで表示（既存のassignedPartnerIdがあればそれを選択状態に）
            resolvePartnerFromCategory();
            if (item.assignedPartnerId) {
                document.getElementById('itemAssignedPartner').value = item.assignedPartnerId;
                var partnerSelect = document.getElementById('itemAssignedPartnerSelect');
                // 既存の管理会社がプルダウンに含まれていれば選択
                for (var i = 0; i < partnerSelect.options.length; i++) {
                    if (partnerSelect.options[i].value === item.assignedPartnerId) {
                        partnerSelect.selectedIndex = i;
                        break;
                    }
                }
            }
            document.getElementById('itemUnit').value = item.unit || '個';
            document.getElementById('itemPrice').value = item.price || 0;
            document.getElementById('itemStock').value = item.stock || 0;
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('itemFloor').value = item.floor || '';
            document.getElementById('itemLocation').value = item.location || '';
            document.getElementById('itemEndDate').value = item.endDate || '';

            document.body._scrollY = window.scrollY;
            document.body.style.top = (-window.scrollY) + 'px';
            document.body.classList.add('modal-open');
            document.getElementById('itemModal').classList.add('show');
            buildCategoryOptions();
            document.getElementById('itemCategory').value = item.category || '';
            initOfficeSelect();
            // 編集時: 事業所を選択状態に
            var officeSelect = document.getElementById('itemOfficeSelect');
            if (officeSelect && item.officeCode) {
                officeSelect.value = item.officeCode;
            }
        }

        // モーダル閉じる
        function closeModal() {
            document.body.classList.remove('modal-open');
            document.body.style.top = '';
            window.scrollTo(0, document.body._scrollY || 0);
            document.getElementById('itemModal').classList.remove('show');
        }

        // 保存
        // 監査ログ記録
        function logItemEvent(type, detail) {
            try {
                var logs = JSON.parse(demoGetFromLocalStorage('audit.logs') || '[]');
                logs.push({
                    timestamp: new Date().toISOString(),
                    type: type,
                    screen: 'items',
                    user: currentUser?.name || '',
                    userId: currentUser?.userId || currentUser?.id || '',
                    companyCode: currentUser?.companyCode || '',
                    details: typeof detail === 'string' ? detail : JSON.stringify(detail)
                });
                demoSaveToLocalStorage('audit.logs', JSON.stringify(logs));
            } catch(e) { console.error('監査ログエラー:', e); }
        }

        async function saveItem(e) {
            e.preventDefault();

            // currentUserを取得（スコープ問題対策）
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            
            if (!currentUser) {
                alert('エラー: ログイン情報が見つかりません');
                return;
            }

            const partnerHidden = document.getElementById('itemAssignedPartner');
            const partnerSelect = document.getElementById('itemAssignedPartnerSelect');
            var partnerDisplayName = partnerSelect.options[partnerSelect.selectedIndex] ? partnerSelect.options[partnerSelect.selectedIndex].text : '';
            
            // 管理会社ログイン時は納品先会社を使用
            let companyCode = currentUser.companyCode;
            let officeCode = currentUser.officeCode;
            
            if (currentUser.role === 'contractor') {
                const deliveryCompany = document.getElementById('itemDeliveryCompany').value;
                if (!deliveryCompany) {
                    alert('納品先会社を選択してください');
                    return;
                }
                companyCode = deliveryCompany;
                officeCode = '';
            }

            // 本社管理者・システム管理者は事業所選択から取得
            if (currentUser.role === 'company_admin' || currentUser.role === 'system_admin') {
                var officeSelect = document.getElementById('itemOfficeSelect');
                if (officeSelect && officeSelect.value) {
                    officeCode = officeSelect.value;
                }
            }

            // カテゴリ必須チェック
            var categoryVal = document.getElementById('itemCategory').value;
            if (!categoryVal) {
                alert('カテゴリーを選択してください');
                document.getElementById('itemCategory').focus();
                return;
            }
            
            const item = {
                itemId: document.getElementById('itemId').value || null,
                companyCode: companyCode,
                officeCode: officeCode,
                name: document.getElementById('itemName').value,
                maker: document.getElementById('itemMaker').value,
                model: document.getElementById('itemModel').value,
                category: document.getElementById('itemCategory').value,
                assignedPartnerId: partnerHidden.value || null,
                assignedPartnerName: partnerDisplayName || '',
                unit: document.getElementById('itemUnit').value,
                price: parseFloat(document.getElementById('itemPrice').value) || 0,
                stock: parseFloat(document.getElementById('itemStock').value) || 0,
                description: document.getElementById('itemDescription').value,
                floor: document.getElementById('itemFloor').value,
                location: document.getElementById('itemLocation').value,
                endDate: document.getElementById('itemEndDate').value
            };

            // 推奨項目の未入力チェック
            var warnings = [];
            if (!item.floor) warnings.push('設置場所（フロア）');
            if (warnings.length > 0) {
                if (!confirm(warnings.join('・') + ' が未入力です。\nあとから検索・絞り込みしやすくなるため、入力を推奨します。\n\nこのまま保存しますか？')) {
                    return;
                }
            }
            

            try {
                if (currentEditId) {
                    // 更新時: 管理会社変更履歴を記録
                    const oldItem = allItems.find(i => i.itemId === currentEditId);
                    
                    if (oldItem && oldItem.assignedPartnerId !== item.assignedPartnerId) {
                        
                        // 管理会社変更履歴を初期化（存在しない場合）
                        if (!item.partnerHistory) {
                            item.partnerHistory = oldItem.partnerHistory || [];
                        }
                        
                        // 変更履歴を追加
                        item.partnerHistory.push({
                            changedAt: new Date().toISOString(),
                            changedBy: currentUser.userId || currentUser.id,
                            changedByName: currentUser.userName || currentUser.name,
                            oldPartnerId: oldItem.assignedPartnerId,
                            oldPartnerName: oldItem.assignedPartnerName,
                            newPartnerId: item.assignedPartnerId,
                            newPartnerName: item.assignedPartnerName
                        });
                        
                    } else {
                        // 管理会社変更がない場合は既存の履歴を保持
                        item.partnerHistory = oldItem?.partnerHistory || [];
                    }
                    
                    // 更新者情報を追加
                    item.updatedBy = currentUser.userId || currentUser.id;
                    item.updatedByRole = currentUser.role;
                    item.updatedAt = new Date().toISOString();
                    
                    await ItemStorage.updateItem(item);
                    logItemEvent('update_item', { itemId: item.itemId, itemName: item.name });
                    alert('商品を更新しました');
                } else {
                    // 新規登録: 登録者情報を追加
                    item.createdBy = currentUser.userId || currentUser.id;
                    item.createdByRole = currentUser.role;
                    item.createdAt = new Date().toISOString();
                    item.updatedAt = new Date().toISOString();
                    item.partnerHistory = []; // 履歴を初期化
                    
                    await ItemStorage.addItem(item);
                    logItemEvent('add_item', { itemId: item.itemId, itemName: item.name });
                    alert('商品を登録しました');
                }

                closeModal();
                await loadItems(true);
            } catch (e) {
                console.error('[saveItem] エラー:', e);
                alert('エラーが発生しました:\n\n' + e.message + '\n\n' + e.stack);
            }
        }

        // 削除
        // エクスポート
        function exportItems() {

            const csv = [
                ['商品No.', '商品名', '担当管理会社', 'メーカー', '型番', 'カテゴリー', 'フロア', '設置場所', '単価', '在庫', '単位', '備考', '終了日', '登録日', '更新日'].join(','),
                ...allItems.map(item => [
                    item.itemId || '',
                    item.name || '',
                    item.assignedPartnerName || '',
                    item.maker || '',
                    item.model || '',
                    item.category || '',
                    item.floor || '',
                    item.location || '',
                    item.price || 0,
                    item.stock || 0,
                    item.unit || '個',
                    item.description || '',
                    item.endDate || '',
                    formatDate(item.createdAt),
                    formatDate(item.updatedAt)
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `items-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // インポート
        function openImport() {
            window.location.href = 'import.html';
        }

        // 戻る
        // 戻る（ロールに応じたホームに遷移）
        function goBack() {
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
                
                if (!currentUser || !currentUser.role) {
                    window.location.href = 'login.html';
                    return;
                }

                // ロール別のホーム画面
                const homePages = {
                    'system_admin': 'system-admin.html',
                    'company_admin': 'master-top.html',
                    'office_admin': 'master-top.html',
                    'staff': 'report.html',
                    'contractor': 'contractor-dashboard.html'
                };

                const homePage = homePages[currentUser.role] || 'master-top.html';
                window.location.href = homePage;
            } catch (e) {
                console.error('goBack error:', e);
                window.location.href = 'master-top.html';
            }
        }

        // ログアウト
        function logout() {
            if (confirm('ログアウトしますか？')) {
                sessionStorage.clear();
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            }
        }
        
        // 初回ログインバナー表示
        function showFirstLoginBanner() {
            if (currentUser && currentUser.isFirstLogin && !sessionStorage.getItem('firstLoginBannerDismissed')) {
                document.getElementById('firstLoginBanner').style.display = 'block';
            }
        }
        
        // 初回ログインバナーを閉じる
        function dismissFirstLoginBanner() {
            document.getElementById('firstLoginBanner').style.display = 'none';
            sessionStorage.setItem('firstLoginBannerDismissed', 'true');
        }
        
        // バナーからパスワード変更モーダルを開く
        function openPasswordChangeFromBanner() {
            dismissFirstLoginBanner();
            openPasswordChangeModal();
        }
        
        // 初期化実行
        init();
        
        // DEMOモード表示
        if (currentUser && isDemoMode()) {
            document.getElementById('demoModeBadge').style.display = 'block';
        }
        
        // 初回ログインバナー表示
        showFirstLoginBanner();
        
        // パスワード変更モーダル
        function openPasswordChangeModal() {
            document.body._scrollY = window.scrollY;
            document.body.style.top = (-window.scrollY) + 'px';
            document.body.classList.add('modal-open');
            document.getElementById('passwordChangeModal').style.display = 'flex';
            document.getElementById('dropdownMenu').classList.remove('show');
        }
        
        function closePasswordChangeModal() {
            document.body.classList.remove('modal-open');
            document.body.style.top = '';
            window.scrollTo(0, document.body._scrollY || 0);
            document.getElementById('passwordChangeModal').style.display = 'none';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }
        
        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('すべての項目を入力してください。');
                return;
            }
            
            // 新しいパスワードの確認
            if (newPassword !== confirmPassword) {
                alert('新しいパスワードが一致しません。');
                return;
            }
            
            // パスワードの長さチェック
            if (newPassword.length < 6) {
                alert('パスワードは6文字以上で設定してください。');
                return;
            }
            
            // 現在のパスワード確認
            if (currentUser.password !== currentPassword) {
                alert('現在のパスワードが正しくありません。');
                return;
            }
            
            // パスワード更新
            try {
                const isDemo = isDemoMode();
                
                if (isDemo) {
                    // DEMOモード: currentUserのみ更新（セッション中のみ有効）
                    currentUser.password = newPassword;
                    currentUser.isFirstLogin = false;  // 初回ログインフラグをfalseに
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    alert('パスワードを変更しました。\n※ DEMOモードのため、ログアウト後は元に戻ります。');
                    closePasswordChangeModal();
                } else {
                    // 本番モード: localStorageのaccountsを更新
                    let accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                    const accountIndex = accounts.findIndex(a => a.userId === currentUser.userId);
                    
                    if (accountIndex !== -1) {
                        accounts[accountIndex].password = newPassword;
                        accounts[accountIndex].isFirstLogin = false;  // 初回ログインフラグをfalseに
                        accounts[accountIndex].passwordChangedAt = new Date().toISOString();
                        localStorage.setItem('accounts', JSON.stringify(accounts));
                        
                        // currentUserも更新
                        currentUser.password = newPassword;
                        currentUser.isFirstLogin = false;
                        sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                        
                        alert('パスワードを変更しました。');
                        closePasswordChangeModal();
                    } else {
                        alert('アカウント情報の更新に失敗しました。');
                    }
                }
            } catch (e) {
                console.error('パスワード変更エラー:', e);
                alert('パスワード変更に失敗しました。');
            }
        }
    </script>
    
    <!-- パスワード変更モーダル -->
    <div id="passwordChangeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 400px; box-shadow: 0 8px 24px rgba(0,0,0,0.2);">
            <h2 style="margin: 0 0 20px 0; font-size: 20px; color: #333;">パスワード変更</h2>
            
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 14px; color: #666; margin-bottom: 6px;">現在のパスワード</label>
                <input type="password" id="currentPassword" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
            </div>
            
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 14px; color: #666; margin-bottom: 6px;">新しいパスワード</label>
                <input type="password" id="newPassword" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
                <div style="font-size: 12px; color: #666; margin-top: 4px;">※ 6文字以上で入力してください</div>
            </div>
            
            <div style="margin-bottom: 24px;">
                <label style="display: block; font-size: 14px; color: #666; margin-bottom: 6px;">新しいパスワード（確認）</label>
                <input type="password" id="confirmPassword" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="closePasswordChangeModal()" style="padding: 10px 20px; background: #f5f5f5; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; color: #666;">キャンセル</button>
                <button onclick="changePassword()" style="padding: 10px 20px; background: #1e3a5f; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; color: white;">変更する</button>
            </div>
        </div>
    </div>
    
    <!-- 初回ログイン推奨バナー -->
    <div id="firstLoginBanner" style="display: none; position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: #1e3a5f; color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 20px rgba(37, 99, 235, 0.3); z-index: 9999; max-width: 500px; width: 90%;">
        <div style="display: flex; align-items: center; gap: 16px;">
            <div style="font-size: 32px;"></div>
            <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 4px;">パスワードの変更をおすすめします</div>
                <div style="font-size: 13px; opacity: 0.9;">セキュリティ向上のため、初期パスワードを変更することを推奨します。</div>
            </div>
            <button onclick="dismissFirstLoginBanner()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 20px; line-height: 1;">×</button>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 12px;">
            <button onclick="openPasswordChangeFromBanner()" style="flex: 1; padding: 8px 16px; background: white; color: #1e293b; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">今すぐ変更</button>
            <button onclick="dismissFirstLoginBanner()" style="flex: 1; padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">後で変更</button>
        </div>
    </div>
</body>
</html>
