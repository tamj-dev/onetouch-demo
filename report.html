<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1e3a5f">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
  <title>é€šå ± | ãƒ¯ãƒ³ã‚¿ãƒƒãƒç®¡ç†</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="demo-mode.js"></script>
  <script src="unified-header.js"></script>
  <script>
    // ONE.jsã®ä»£æ›¿ï¼ˆcore.jsãŒãªã„å ´åˆã®äº’æ›æ€§ã®ãŸã‚ï¼‰
    window.ONE = window.ONE || {};
    ONE.KEYS = {
      loggedIn: 'ONE_loggedIn',
      userId: 'ONE_userId',
      userName: 'ONE_userName',
      provider: 'ONE_provider'
    };
    ONE.isLoggedIn = function() {
      return demoGetFromLocalStorage(ONE.KEYS.loggedIn) === '1' || sessionStorage.getItem('currentUser');
    };
    ONE.getUserName = function() {
      return demoGetFromLocalStorage(ONE.KEYS.userName) || 'ã‚²ã‚¹ãƒˆ';
    };
    ONE.requireFlow = function() {
      return 'report.html';
    };
    ONE.logEvent = function() {};
    ONE.randId = function() {
      return 'USR' + Math.random().toString(36).substr(2, 9);
    };
  </script>
  <!-- core.js ã¯çµ±åˆæ¸ˆã¿ãƒ»ä¸è¦ -->
  <script>if(!ONE.isLoggedIn())location.replace("login.html");</script>
  <style>
    :root{--bg:#f5f5f5;--card:#fff;--border:#e8e8e8;--border-light:#ddd;--text:#1e293b;--text-dim:#888;--text-muted:#aaa;--danger:#dc2626;}
    *{margin:0;padding:0;box-sizing:border-box;}
    html{overflow-x:hidden;}
    body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column;overflow-x:hidden;}
    body.modal-open{overflow:hidden;position:fixed;width:100%;}

    .main{flex:0;display:flex;flex-direction:column;align-items:center;padding:24px;gap:16px;max-width:400px;margin:0 auto;width:100%;}

    /* é€šå ±ãƒœã‚¿ãƒ³ */
    .report-btn{
      width:100%;padding:28px 20px;border:1px solid var(--border);border-radius:16px;
      cursor:pointer;font-family:inherit;text-align:center;
      transition:all .2s;
      display:flex;flex-direction:column;align-items:center;gap:8px;
      background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.04);
    }
    .report-btn:hover{border-color:#ccc;box-shadow:0 4px 16px rgba(0,0,0,0.08);transform:translateY(-2px);}
    .report-btn:active{transform:translateY(0);}
    .report-btn h2{font-size:1.1rem;font-weight:700;margin:0;color:var(--text);}
    .report-btn p{font-size:0.8rem;margin:0;color:var(--text-dim);}

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.3);display:none;align-items:center;justify-content:center;padding:16px;z-index:999;overscroll-behavior:contain;-webkit-overflow-scrolling:touch;}
    .overlay.open{display:flex;}
    .modal{width:min(480px,100%);max-height:90vh;overflow:auto;background:#fff;border-radius:16px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.15);}
    .modal h3{font-size:1.25rem;font-weight:700;margin-bottom:16px;color:var(--text);}
    .field{margin-bottom:14px;}
    .field label{display:block;font-size:16px;color:var(--text-dim);margin-bottom:6px;font-weight:600;}
    .field select,.field input,.field textarea{width:100%;padding:12px 14px;border:1px solid var(--border-light);border-radius:10px;font-family:inherit;font-size:18px;background:#fff;color:var(--text);}
    .field select:focus,.field input:focus,.field textarea:focus{outline:none;border-color:#999;box-shadow:0 0 0 3px rgba(0,0,0,0.04);}
    .field textarea{resize:vertical;min-height:80px;}
    .modal-btns{display:flex;gap:10px;justify-content:flex-end;margin-top:18px;}
    .mbtn{border:none;border-radius:10px;padding:16px 24px;font-family:inherit;font-size:16px;font-weight:600;cursor:pointer;min-height:56px;}
    .mbtn-cancel{background:#f0f0f0;color:#666;}
    .mbtn-send{background:#1e3a5f;color:#fff;}
    .mbtn-danger{background:var(--danger);color:#fff;}

    /* å†™çœŸæ·»ä»˜ */
    .photo-section{margin-bottom:14px;}
    .photo-label{display:block;font-size:16px;color:var(--text-dim);margin-bottom:6px;font-weight:600;}
    .photo-add-btn{display:flex;align-items:center;gap:8px;padding:12px 16px;background:#fafafa;border:1px dashed var(--border-light);border-radius:10px;cursor:pointer;color:var(--text-dim);font-size:16px;transition:all .2s;}
    .photo-add-btn:hover{border-color:#999;color:#666;}
    .photo-add-btn svg{flex-shrink:0;}
    .photo-previews{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;}
    .photo-thumb{position:relative;width:72px;height:72px;border-radius:8px;overflow:hidden;border:1px solid var(--border);}
    .photo-thumb img{width:100%;height:100%;object-fit:cover;}
    .photo-thumb .remove-photo{position:absolute;top:2px;right:2px;width:20px;height:20px;background:rgba(0,0,0,.6);border:none;border-radius:50%;color:#fff;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;}

    /* é€ä¿¡çµæœ */
    .result{margin-top:16px;padding:14px;border-radius:10px;background:#e8f0fe;border:1px solid #93b4f5;font-size:16px;display:none;color:#1e3a5f;}

    /* ãƒˆãƒ¼ã‚¹ãƒˆ */
    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:#1e3a5f;color:#fff;padding:12px 24px;border-radius:12px;font-size:16px;font-weight:500;box-shadow:0 4px 20px rgba(0,0,0,.2);opacity:0;transition:all .4s;z-index:9999;pointer-events:none;white-space:nowrap;}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1;}

    /* é€ä¿¡å®Œäº†ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .sent-ok{position:fixed;inset:0;background:rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;z-index:9998;animation:fadeIn .3s;}
    .sent-ok-card{background:#fff;border-radius:20px;padding:40px 32px;text-align:center;max-width:380px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.15);animation:popIn .35s;}
    .sent-ok-icon{font-size:48px;margin-bottom:12px;color:var(--text);}
    .sent-ok-title{font-size:1.1rem;font-weight:700;margin-bottom:6px;color:var(--text);}
    .sent-ok-sub{font-size:1rem;color:var(--text-dim);line-height:1.5;}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes popIn{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ãƒ– */
    .status-tabs{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:16px;}
    .status-tab{background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px 8px;cursor:pointer;transition:all .2s;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,0.03);}
    .status-tab:hover{border-color:#ccc;}
    .status-tab.active{background:#1e3a5f;border-color:#1e3a5f;}
    .status-tab-label{font-size:14px;color:var(--text-dim);margin-bottom:4px;}
    .status-tab.active .status-tab-label{color:rgba(255,255,255,.7);font-weight:600;}
    .status-tab-count{font-size:24px;font-weight:700;color:var(--text);}
    .status-tab.active .status-tab-count{color:#fff;}
    @media (max-width:480px){.status-tabs{grid-template-columns:repeat(3,1fr);}}

    /* é€šå ±å±¥æ­´ã‚«ãƒ¼ãƒ‰ */
    .history-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:10px;transition:all .2s;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,0.03);}
    .history-card:hover{border-color:#ccc;box-shadow:0 4px 12px rgba(0,0,0,0.06);}
    .history-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;}
    .history-title{font-size:17px;font-weight:700;color:var(--text);margin-bottom:4px;}
    .history-id{font-size:14px;color:var(--text-muted);}
    .status-badge{padding:4px 12px;border-radius:8px;font-size:14px;font-weight:600;}
    .status-pending{background:#fef3c7;color:#b45309;}
    .status-progress{background:#dbeafe;color:#1d4ed8;}
    .status-complete{background:#e8f0fe;color:#1e3a5f;}
    .status-unavailable{background:#fee2e2;color:#dc2626;}
    .history-info{display:flex;flex-wrap:wrap;gap:12px;font-size:14px;color:var(--text-dim);margin-bottom:8px;}
    .history-info span{display:flex;align-items:center;gap:4px;}
    .priority-high{color:#dc2626;font-weight:600;}
    .priority-mid{color:#d97706;font-weight:600;}
    .priority-low{color:#2563eb;font-weight:600;}
    .history-partner{font-size:14px;color:#1d4ed8;font-weight:600;margin-bottom:8px;padding:4px 10px;background:#eff6ff;border-radius:6px;display:inline-block;}
    .history-comment{background:#fafafa;padding:8px 12px;border-radius:6px;font-size:16px;color:var(--text);margin-top:8px;border-left:3px solid #ddd;}
    .history-duration{font-size:14px;color:#2563eb;font-weight:600;margin-top:4px;}

    /* é€šå ±è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .detail-modal{max-width:500px;}
    .detail-row{margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid #f0f0f0;}
    .detail-row:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0;}
    .detail-label{font-size:0.875rem;color:var(--text-dim);font-weight:600;margin-bottom:4px;}
    .detail-value{font-size:1rem;color:var(--text);}
    .detail-desc{background:#fafafa;padding:12px;border-radius:8px;line-height:1.6;white-space:pre-wrap;color:var(--text);}
    .detail-photos{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
    .detail-photos img{max-width:200px;border-radius:8px;border:1px solid var(--border);cursor:pointer;}

    /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ */
    .timeline{padding:0;margin:0;list-style:none;}
    .timeline-item{display:flex;gap:12px;padding-bottom:18px;position:relative;}
    .timeline-item:last-child{padding-bottom:0;}
    .timeline-left{width:90px;flex-shrink:0;text-align:right;padding-top:2px;}
    .timeline-date{font-size:14px;color:#888;line-height:1.4;}
    .timeline-dot-line{display:flex;flex-direction:column;align-items:center;flex-shrink:0;}
    .timeline-dot{width:10px;height:10px;border-radius:50%;background:#ddd;flex-shrink:0;margin-top:4px;}
    .timeline-dot.status-change{background:#1e3a5f;width:12px;height:12px;}
    .timeline-dot.st-pending{background:#d97706;}
    .timeline-dot.st-progress{background:#2563eb;}
    .timeline-dot.st-complete{background:#1e3a5f;}
    .timeline-dot.st-unavailable{background:#dc2626;}
    .timeline-line{width:1px;background:#e0e0e0;flex-grow:1;margin-top:4px;}
    .timeline-item:last-child .timeline-line{display:none;}
    .timeline-content{flex:1;min-width:0;padding-top:0;}
    .timeline-status{font-size:16px;font-weight:600;color:#1e293b;margin-bottom:2px;}
    .timeline-comment{font-size:16px;color:#666;line-height:1.5;}
  </style>
</head>
<body>

  <!-- çµ±ä¸€ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div id="unified-header-mount"></div>

  <div class="main">
    <button class="report-btn" onclick="openForm('report')" style="max-width: 360px; padding: 32px 24px;">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      <h2 style="font-size:20px;">æ•…éšœãªã©ã®é€šå ±</h2>
      <p style="font-size:16px;">è‡ªå‹•ã§æ‹…å½“ã«å±Šãã¾ã™</p>
    </button>
    <a href="report-help.html" style="font-size: 16px; color: var(--text-muted); text-decoration: none; margin-top: 4px;">é€šå ±ã®ä»•æ–¹ãŒã‚ã‹ã‚‰ãªã„æ–¹ã¯ã“ã¡ã‚‰</a>
    
  </div>

  <!-- é€šå ±å±¥æ­´ -->
  <div style="width:100%;max-width:700px;margin:0 auto;padding:0 20px 24px;">
    <h2 style="font-size:1rem;font-weight:700;margin-bottom:12px;color:#ddd;display:flex;align-items:center;gap:8px;">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/></svg>
      é€šå ±å±¥æ­´
    </h2>

    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ãƒ– -->
    <div class="status-tabs">
      <div class="status-tab active" onclick="filterByStatus('all', this)">
        <div class="status-tab-label">ã™ã¹ã¦</div>
        <div class="status-tab-count" id="countAll">0</div>
      </div>
      <div class="status-tab" onclick="filterByStatus('æœªå¯¾å¿œ', this)">
        <div class="status-tab-label">å—ä»˜æ¸ˆ</div>
        <div class="status-tab-count" id="countPending">0</div>
      </div>
      <div class="status-tab" onclick="filterByStatus('å¯¾å¿œä¸­', this)">
        <div class="status-tab-label">å¯¾å¿œä¸­</div>
        <div class="status-tab-count" id="countProgress">0</div>
      </div>
      <div class="status-tab" onclick="filterByStatus('å®Œäº†', this)">
        <div class="status-tab-label">è§£æ±ºæ¸ˆ</div>
        <div class="status-tab-count" id="countComplete">0</div>
      </div>
      <div class="status-tab" onclick="filterByStatus('å¯¾å¿œä¸å¯', this)">
        <div class="status-tab-label">å¯¾å¿œã§ãã¾ã›ã‚“</div>
        <div class="status-tab-count" id="countUnavailable">0</div>
      </div>
    </div>

    <div id="historyArea">
      <div style="text-align:center;padding:24px;color:var(--text-muted);font-size:0.85rem;">é€šå ±å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>
    </div>
  </div>

  <!-- é€šå ±ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="overlay" id="formOverlay">
    <div class="modal">
      <h3 id="formTitle">é€šå ±</h3>
      <input type="hidden" id="formType">
      
      <div class="field">
        <label>è¨­å‚™å/å•†å“å</label>
        <div id="equipmentSelector">
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px;" id="categoryTabs"></div>
          <div style="position:relative;">
            <input type="text" id="equipmentSearch" placeholder="è¨­å‚™åãƒ»å‹ç•ªãƒ»ãƒ¡ãƒ¼ã‚«ãƒ¼ã§æ¤œç´¢" autocomplete="off"
              style="width:100%;padding:12px 44px 12px 14px;border:1px solid #ddd;border-radius:8px;font-size:15px;background:#fafafa;">
            <button type="button" id="voiceSearchBtn" onclick="startVoice('equipmentSearch')" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;padding:6px;border-radius:50%;transition:background .2s;" title="éŸ³å£°ã§æ¤œç´¢">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="1" width="6" height="11" rx="3"/><path d="M19 10v1a7 7 0 01-14 0v-1"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
            </button>
            <div id="suggestList" style="display:none;position:absolute;left:0;right:0;top:100%;background:white;border:1px solid #ddd;border-top:none;border-radius:0 0 8px 8px;max-height:240px;overflow-y:auto;z-index:100;box-shadow:0 8px 24px rgba(0,0,0,.12);"></div>
          </div>
          <div id="selectedEquipment" style="display:none;margin-top:8px;padding:10px 14px;background:#e8f0fe;border:1px solid #93b4f5;border-radius:8px;font-size:14px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <span id="selectedEquipmentName" style="font-weight:600;"></span>
              <button onclick="clearEquipmentSelection()" style="background:none;border:none;color:#888;font-size:18px;cursor:pointer;padding:0 4px;">x</button>
            </div>
            <div id="selectedEquipmentDetail" style="font-size:12px;color:#666;margin-top:2px;"></div>
          </div>
        </div>
        <select id="formTitleInput" style="display:none;" required>
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
        <div style="display:none;">
          <input type="hidden" id="selectedItemId">
          <input type="hidden" id="selectedPartnerId">
          <input type="hidden" id="selectedPartnerName">
        </div>
      </div>
      
      <input type="hidden" id="formCat" value="ãã®ä»–">
      
      <input type="hidden" id="formPriority" value="">
      
      <div class="field">
        <label>çŠ¶æ³</label>
        <div style="position:relative;">
          <textarea id="formDesc" placeholder="ä¾‹ï¼š3éšå»Šä¸‹ã®ã‚¨ã‚¢ã‚³ãƒ³ãŒå‹•ãã¾ã›ã‚“" maxlength="200" style="padding-right:44px;"></textarea>
          <button type="button" id="voiceDescBtn" onclick="startVoice('formDesc')" style="position:absolute;right:8px;top:12px;background:none;border:none;cursor:pointer;padding:6px;border-radius:50%;transition:background .2s;" title="éŸ³å£°ã§å…¥åŠ›">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="1" width="6" height="11" rx="3"/><path d="M19 10v1a7 7 0 01-14 0v-1"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
          </button>
        </div>
        <div style="font-size:14px;color:#aaa;margin-top:4px;text-align:right;" id="formDescCount">0/200</div>
      </div>

      <!-- å†™çœŸæ·»ä»˜ -->
      <div class="photo-section">
        <div class="photo-label">å†™çœŸï¼ˆæœ€å¤§3æšï¼‰</div>
        <div style="font-size:16px;color:#2563eb;margin-bottom:6px;">ğŸ“· å†™çœŸãŒã‚ã‚‹ã¨ç®¡ç†ä¼šç¤¾ã«ä¼ã‚ã‚Šã‚„ã™ããªã‚Šã¾ã™</div>
        <input type="file" id="photoInput" accept="image/*" multiple style="display:none;" onchange="handlePhotos(this)">
        <div class="photo-add-btn" onclick="document.getElementById('photoInput').click()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21,15 16,10 5,21"/></svg>
          æ’®å½±ã™ã‚‹ / ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‹ã‚‰é¸æŠ
        </div>
        <div class="photo-previews" id="photoPreviews"></div>
      </div>
      
      <div class="modal-btns">
        <button class="mbtn mbtn-cancel" onclick="closeForm()">ã‚„ã‚ã‚‹</button>
        <button class="mbtn mbtn-send" id="formSendBtn" onclick="send()">é€šå ±ã™ã‚‹</button>
      </div>
      <div class="result" id="formResult"></div>
    </div>
  </div>

  <!-- é€šå ±è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="overlay" id="detailOverlay">
    <div class="modal detail-modal">
      <h3 id="detailTitle">é€šå ±è©³ç´°</h3>
      <div id="detailContent"></div>
      <div class="modal-btns">
        <button class="mbtn mbtn-cancel" onclick="closeDetail()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ONEã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if (typeof ONE === 'undefined') {
      window.ONE = {
        isLoggedIn: function() {
          return demoGetFromLocalStorage('one_logged_in') === '1';
        },
        getUserName: function() {
          return demoGetFromLocalStorage('one_user_id') || 'ã‚²ã‚¹ãƒˆ';
        },
        logout: function() {
          demoDeleteFromLocalStorage('one_logged_in');
          demoDeleteFromLocalStorage('one_provider');
          demoDeleteFromLocalStorage('one_user_id');
        },
        randId: function(prefix) {
          return (prefix || '') + Math.random().toString(36).substr(2, 9).toUpperCase();
        },
        logEvent: function(event, data) {
        },
        sendLocalNotify: function(title, body, options) {
        }
      };
    }

    // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
    if(!ONE.isLoggedIn()) {
      location.replace("login.html");
    }

    // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));

    // çµ±ä¸€ãƒ˜ãƒƒãƒ€ãƒ¼åˆæœŸåŒ–ï¼ˆé€šå ±ç”»é¢ã¯ã‚¹ã‚¿ãƒƒãƒ•ã®ãƒ›ãƒ¼ãƒ ç”»é¢ãªã®ã§æˆ»ã‚‹ãƒœã‚¿ãƒ³ãªã—ï¼‰
    UnifiedHeader.init({
        icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
        title: 'é€šå ±',
        backButton: currentUser && (currentUser.role === 'company_admin' || currentUser.role === 'office_admin' || currentUser.role === 'system_admin'),
    });

    var labels={wholesale:'éƒ¨å±‹ãƒ»å…±ç”¨éƒ¨',building:'éƒ¨å±‹ãƒ»å…±ç”¨éƒ¨',welfare:'ä»‹è­·åŒ»ç™‚å‚™å“',emergency:'ç·Šæ€¥',report:'è¨­å‚™ãƒˆãƒ©ãƒ–ãƒ«'};
    var typeLabels={wholesale:'éƒ¨å±‹ãƒ»å…±ç”¨éƒ¨',building:'éƒ¨å±‹ãƒ»å…±ç”¨éƒ¨',welfare:'ä»‹è­·åŒ»ç™‚å‚™å“',emergency:'ç·Šæ€¥',report:'è¨­å‚™ãƒˆãƒ©ãƒ–ãƒ«'};

    // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
    var formDesc = document.getElementById('formDesc');
    var formDescCount = document.getElementById('formDescCount');
    if (formDesc && formDescCount) {
      formDesc.addEventListener('input', function() {
        formDescCount.textContent = formDesc.value.length + '/200';
      });
    }

    function openForm(type){
      document.body._scrollY=window.scrollY;
      document.body.style.top=(-window.scrollY)+'px';
      document.body.classList.add('modal-open');
      document.getElementById('formType').value=type;
      document.getElementById('formTitle').textContent='ãƒˆãƒ©ãƒ–ãƒ«é€šå ±';
      document.getElementById('formResult').style.display='none';
      
      // å•†å“ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
      loadItems();
      
      document.getElementById('formOverlay').classList.add('open');
    }
    
    // å•†å“ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    var _allEquipments = [];
    var _activeCategory = '';

    function loadItems() {
      try {
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        const isDemoMode = currentUser && (currentUser.companyCode === 'TAMJ' || currentUser.companyCode === 'JMAT' || currentUser.companyCode === 'SYSTEM' || currentUser.isDemoMode);
        
        let items = [];
        
        if (isDemoMode) {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¤‰ã‚ã£ãŸã‚‰demo.itemsã‚’ãƒªã‚»ãƒƒãƒˆ
          var cachedUser = sessionStorage.getItem('demo.items.user');
          var currentId = currentUser.userId || currentUser.id || '';
          if (cachedUser && cachedUser !== currentId) {
            sessionStorage.removeItem('demo.items');
          }
          // DEMOãƒ¢ãƒ¼ãƒ‰: sessionStorageã‹ã‚‰å–å¾—ã€ãªã‘ã‚Œã°localStorageã‹ã‚‰ã‚³ãƒ”ãƒ¼
          items = JSON.parse(sessionStorage.getItem('demo.items') || '[]');
          if (items.length === 0) {
            var allItems = JSON.parse(localStorage.getItem('onetouch.items') || '[]');
            if (currentUser.role === 'contractor') {
              var assigned = currentUser.assignedCompanies || [];
              if (assigned.length > 0) {
                items = allItems.filter(function(i) { return assigned.indexOf(i.companyCode) >= 0; });
              } else {
                items = allItems;
              }
            } else if (currentUser.role === 'system_admin') {
              items = allItems;
            } else if (currentUser.role === 'company_admin') {
              items = allItems.filter(function(i) { return i.companyCode === currentUser.companyCode; });
            } else {
              items = allItems.filter(function(i) { return i.officeCode === currentUser.officeCode; });
            }
            if (items.length > 0) {
              sessionStorage.setItem('demo.items', JSON.stringify(items));
              sessionStorage.setItem('demo.items.user', currentId);
            }
          }
        } else {
          // æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰: localStorageã‹ã‚‰å–å¾—
          var allItems = JSON.parse(localStorage.getItem('onetouch.items') || '[]');
          if (currentUser.role === 'system_admin') {
            items = allItems;
          } else if (currentUser.role === 'company_admin') {
            items = allItems.filter(function(i) { return i.companyCode === currentUser.companyCode; });
          } else {
            items = allItems.filter(function(i) { return i.officeCode === currentUser.officeCode; });
          }
        }
        
        // ãƒ­ãƒ¼ãƒ«ã«å¿œã˜ãŸãƒ•ã‚£ãƒ«ã‚¿
        if (currentUser.role === 'contractor') {
          var assigned = currentUser.assignedCompanies || [];
          if (assigned.length > 0) {
            items = items.filter(function(item) { return assigned.indexOf(item.companyCode) >= 0; });
          }
        } else if (currentUser.role !== 'system_admin' && currentUser.role !== 'company_admin') {
          items = items.filter(function(item) {
            return item.companyCode === currentUser.companyCode &&
                   (item.officeCode === currentUser.officeCode || !item.officeCode);
          });
        } else if (currentUser.role === 'company_admin') {
          items = items.filter(function(item) {
            return item.companyCode === currentUser.companyCode;
          });
        }
        
        _allEquipments = items;
        
        // æ—§selectã«ã‚‚å…¥ã‚Œã‚‹ï¼ˆsendé–¢æ•°ã®äº’æ›æ€§ã®ãŸã‚ï¼‰
        var select = document.getElementById('formTitleInput');
        select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        items.forEach(function(item) {
          var option = document.createElement('option');
          option.value = item.itemId;
          option.textContent = item.name + (item.maker ? ' (' + item.maker + ')' : '');
          option.dataset.itemId = item.itemId;
          option.dataset.category = item.category || '';
          option.dataset.partnerId = item.assignedPartnerId || '';
          option.dataset.partnerName = item.assignedPartnerName || '';
          select.appendChild(option);
        });
        
        // ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ç”Ÿæˆ
        buildCategoryTabs(items);
        
        // æ¤œç´¢ã‚¤ãƒ™ãƒ³ãƒˆ
        var searchInput = document.getElementById('equipmentSearch');
        searchInput.addEventListener('input', function() { showSuggestions(); });
        searchInput.addEventListener('focus', function() { showSuggestions(); });
        document.addEventListener('click', function(e) {
          if (!e.target.closest('#equipmentSelector')) {
            document.getElementById('suggestList').style.display = 'none';
          }
        });
        
      } catch (e) {
        console.error('[loadItems] ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    function buildCategoryTabs(items) {
      var cats = {};
      items.forEach(function(i) { var c = i.category || 'ãã®ä»–'; cats[c] = (cats[c]||0) + 1; });

      // ã‚«ãƒ†ã‚´ãƒªãƒ¼ON/OFFå–å¾—ï¼ˆæ¨™æº–ï¼‹ã‚«ã‚¹ã‚¿ãƒ ï¼‰
      var companyCode = (currentUser && currentUser.companyCode) ? currentUser.companyCode : 'TAMJ';
      var allCats = (typeof window.getAllCategories === 'function') ? window.getAllCategories(companyCode) : ['å»ºç‰©ãƒ»å¤–','éƒ¨å±‹ãƒ»å…±ç”¨éƒ¨','ä»‹è­·åŒ»ç™‚å‚™å“','å¨æˆ¿','ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯','æµ´å®¤','ç¦ç¥‰ç”¨å…·','ãã®ä»–'];
      var enabledCats = (typeof window.getEnabledCategories === 'function') ? window.getEnabledCategories(companyCode) : allCats;
      var disabledCats = (typeof window.getDisabledCategories === 'function') ? window.getDisabledCategories(companyCode) : [];

      // ç©ºãæ ã®æ•°ã‚’è¨ˆç®—
      var catSettings = (typeof window.getCategorySettings === 'function') ? window.getCategorySettings(companyCode) : null;
      var emptySlots = 0;
      if (catSettings && catSettings.custom) {
        catSettings.custom.forEach(function(c) { if (!c || !c.trim()) emptySlots++; });
      }

      var tabsEl = document.getElementById('categoryTabs');
      var btnBase = 'padding:14px 10px;border-radius:12px;font-size:15px;font-weight:600;text-align:center;line-height:1.4;border:2px solid ';
      var h = '';

      // ON ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆä¸Šæ®µï¼‰
      var onCats = allCats.filter(function(c) { return enabledCats.indexOf(c) !== -1; });
      onCats.forEach(function(c) {
        var count = cats[c] || 0;
        var label = (typeof window.getCategoryDisplayName === 'function') ? window.getCategoryDisplayName(companyCode, c) : c;
        h += '<button onclick="filterCategory(\'' + c.replace(/'/g, "\\'") + '\')" class="cat-tab" data-cat-status="on" style="' + btnBase + '#ddd;background:#fafafa;color:#333;cursor:pointer;">';
        h += '<span style="display:block;font-size:15px;font-weight:700;color:#1e293b;">' + label + '</span>';
        h += '<span style="display:block;font-size:13px;font-weight:700;color:#2563eb;margin-top:4px;">(' + count + ')</span>';
        h += '</button>';
      });

      // OFF ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆä¸‹æ®µãƒ»ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼‰
      disabledCats.forEach(function(c) {
        var label = (typeof window.getCategoryDisplayName === 'function') ? window.getCategoryDisplayName(companyCode, c) : c;
        h += '<button class="cat-tab" data-cat-status="off" disabled style="' + btnBase + '#e5e5e5;background:#f0f0f0;color:#bbb;cursor:not-allowed;opacity:0.55;">';
        h += '<span style="display:block;font-size:15px;font-weight:700;color:#bbb;">' + label + '</span>';
        h += '<span style="display:block;font-size:12px;color:#ccc;margin-top:4px;">æœªä½¿ç”¨</span>';
        h += '</button>';
      });

      // ç©ºãæ ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰
      for (var i = 0; i < emptySlots; i++) {
        h += '<button class="cat-tab" data-cat-status="empty" disabled style="padding:14px 10px;border-radius:12px;font-size:15px;font-weight:600;text-align:center;line-height:1.4;border:2px dashed #ccc;background:#f0f0f0;color:#999;cursor:not-allowed;opacity:0.7;">';
        h += '<span style="display:block;font-size:14px;font-weight:700;color:#999;">ã‚«ã‚¹ã‚¿ãƒ </span>';
        h += '<span style="display:block;font-size:11px;color:#aaa;margin-top:4px;">æœªè¨­å®š</span>';
        h += '</button>';
      }

      tabsEl.innerHTML = h;
    }

    function filterCategory(cat) {
      _activeCategory = cat;
      document.querySelectorAll('.cat-tab').forEach(function(btn) {
        var btnText = btn.textContent.replace(/[\(\d+\)â–¶]/g,'').trim();
        // ã‚«ãƒ†ã‚´ãƒªåã®ä¸€è‡´åˆ¤å®šï¼ˆãƒ©ãƒ™ãƒ«å or å†…éƒ¨åï¼‰
        var isActive = false;
        if (cat === '') {
          isActive = false; // å…¨ã¦è§£é™¤
        } else {
          // ãƒœã‚¿ãƒ³å†…ã®æœ€åˆã®spanãƒ†ã‚­ã‚¹ãƒˆã§åˆ¤å®š
          var firstSpan = btn.querySelector('span');
          if (firstSpan) {
            var labelMap = {'å»ºç‰©ãƒ»å¤–':'å»ºç‰©ãƒ»å¤–','éƒ¨å±‹ãƒ»å…±ç”¨éƒ¨':'éƒ¨å±‹ãƒ»å…±ç”¨éƒ¨','ä»‹è­·åŒ»ç™‚å‚™å“':'ä»‹è­·åŒ»ç™‚å‚™å“','å¨æˆ¿':'å¨æˆ¿','ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯':'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯','ãã®ä»–':'ãã®ä»–'};
            var mapped = labelMap[firstSpan.textContent] || firstSpan.textContent;
            isActive = (mapped === cat);
          }
        }
        if (isActive) {
          btn.style.background = '#eff6ff'; btn.style.borderColor = '#2563eb'; btn.style.boxShadow = '0 0 0 1px #2563eb';
        } else {
          btn.style.background = '#fafafa'; btn.style.borderColor = '#ddd'; btn.style.boxShadow = 'none';
        }
      });
      showSuggestions();
      var searchInput = document.getElementById('equipmentSearch');
      if (cat) searchInput.focus();
    }

    function normalizeStr(s) {
      if (!s) return '';
      return s.replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, function(c) {
        return String.fromCharCode(c.charCodeAt(0) - 0xFEE0);
      }).toLowerCase();
    }

    function showSuggestions() {
      var query = normalizeStr(document.getElementById('equipmentSearch').value);
      var list = document.getElementById('suggestList');
      
      var filtered = _allEquipments.filter(function(item) {
        // ã‚«ãƒ†ã‚´ãƒªçµã‚Šè¾¼ã¿
        if (_activeCategory && (item.category || 'ãã®ä»–') !== _activeCategory) return false;
        // æ¤œç´¢
        if (!query) return true;
        return normalizeStr(item.name).includes(query) ||
               normalizeStr(item.maker).includes(query) ||
               normalizeStr(item.model).includes(query) ||
               normalizeStr(item.description).includes(query);
      });
      
      if (filtered.length === 0) {
        list.innerHTML = '<div style="padding:14px;color:#999;font-size:13px;text-align:center;">è©²å½“ã™ã‚‹è¨­å‚™ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        list.style.display = 'block';
        return;
      }
      
      // å…¨ä»¶è¡¨ç¤ºï¼ˆã‚«ãƒ†ã‚´ãƒªä»¶æ•°ã¨ä¸€è‡´ã•ã›ã‚‹ï¼‰
      var h = '';
      filtered.forEach(function(item) {
        var locParts = [item.floor, item.location].filter(Boolean);
        var locStr = locParts.length > 0 ? locParts.join(' ') : '';
        var maker = item.maker ? '<span style="color:#888;font-size:12px;"> ' + item.maker + '</span>' : '';
        var cat = item.category ? '<span style="display:inline-block;padding:1px 6px;background:#f0f0f0;border-radius:4px;font-size:11px;color:#666;margin-left:6px;">' + item.category + '</span>' : '';
        var locBadge = locStr ? '<span style="display:inline-block;padding:1px 6px;background:#e8f5e9;border-radius:4px;font-size:11px;color:#2e7d32;margin-left:4px;">' + locStr + '</span>' : '';
        h += '<div class="suggest-item" onclick="selectEquipment(\'' + item.itemId + '\')" '
          + 'style="padding:10px 14px;cursor:pointer;border-bottom:1px solid #f5f5f5;transition:background .1s;"'
          + ' onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'white\'">'
          + '<div style="font-size:14px;font-weight:500;">' + item.name + maker + '</div>'
          + '<div style="margin-top:2px;">' + cat + locBadge + '</div>'
          + '</div>';
      });
      if (filtered.length > 100) {
        h += '<div style="padding:10px;color:#888;font-size:12px;text-align:center;">ğŸ’¡ æ¤œç´¢ã§çµã‚Šè¾¼ã‚€ã¨è¦‹ã¤ã‘ã‚„ã™ããªã‚Šã¾ã™</div>';
      }
      list.innerHTML = h;
      list.style.display = 'block';
    }

    function selectEquipment(itemId) {
      var item = _allEquipments.find(function(i) { return i.itemId === itemId; });
      if (!item) return;
      
      // æ—§selectã®å€¤ã‚‚è¨­å®šï¼ˆsendé–¢æ•°ã®äº’æ›æ€§ï¼‰
      document.getElementById('formTitleInput').value = itemId;
      document.getElementById('formCat').value = item.category || 'ãã®ä»–';
      document.getElementById('selectedItemId').value = item.itemId;
      document.getElementById('selectedPartnerId').value = item.assignedPartnerId || '';
      document.getElementById('selectedPartnerName').value = item.assignedPartnerName || '';
      
      // UIæ›´æ–°
      document.getElementById('suggestList').style.display = 'none';
      document.getElementById('equipmentSearch').style.display = 'none';
      document.getElementById('categoryTabs').style.display = 'none';
      var selEl = document.getElementById('selectedEquipment');
      selEl.style.display = 'block';
      document.getElementById('selectedEquipmentName').textContent = item.name;
      var detail = [item.maker, item.model, item.category].filter(Boolean).join(' / ');
      var locParts = [item.floor, item.location].filter(Boolean);
      if (locParts.length > 0) detail += (detail ? ' â€” ' : '') + locParts.join(' ');
      document.getElementById('selectedEquipmentDetail').textContent = detail;
    }

    function clearEquipmentSelection() {
      document.getElementById('formTitleInput').value = '';
      document.getElementById('formCat').value = 'ãã®ä»–';
      document.getElementById('selectedItemId').value = '';
      document.getElementById('selectedPartnerId').value = '';
      document.getElementById('selectedPartnerName').value = '';
      
      // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
      _activeCategory = '';
      
      document.getElementById('equipmentSearch').style.display = '';
      document.getElementById('equipmentSearch').value = '';
      document.getElementById('categoryTabs').style.display = '';
      document.getElementById('selectedEquipment').style.display = 'none';
      document.getElementById('suggestList').style.display = 'none';
      
      // ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ã®è¦‹ãŸç›®ã‚‚ãƒªã‚»ãƒƒãƒˆ
      buildCategoryTabs(_allEquipments);
    }
    function closeForm(){
      document.body.classList.remove('modal-open');
      document.body.style.top='';
      window.scrollTo(0,document.body._scrollY||0);
      document.getElementById('formOverlay').classList.remove('open');
    }

    function getVendor(type){
      try{
        var st=JSON.parse(demoGetFromLocalStorage('asset_demo_v3')||'{}');
        var map={wholesale:'wholesale',building:'bldg',welfare:'welfare'};
        // welfareã‚¿ã‚¤ãƒ—ãŒãªã„å ´åˆwholesaleã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        var v=(st.vendors||[]).find(function(x){return x.type===map[type];});
        if(!v && type==='welfare') v=(st.vendors||[]).find(function(x){return x.type==='wholesale';});
        return v||null;
      }catch(e){return null;}
    }

    function esc(s){return String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;');}

    function send(){
      var type=document.getElementById('formType').value;
      var titleSelect=document.getElementById('formTitleInput');
      var itemId = document.getElementById('selectedItemId').value;
      // é¸æŠã•ã‚ŒãŸè¨­å‚™åã‚’å–å¾—
      var title = '';
      var selectedItem = _allEquipments.find(function(i) { return i.itemId === itemId; });
      if (selectedItem) title = selectedItem.name;
      if (!title && titleSelect.selectedIndex > 0) title = titleSelect.options[titleSelect.selectedIndex].textContent;
      var cat=document.getElementById('formCat').value;
      var priority=document.getElementById('formPriority').value;
      var loc = '';
      if (selectedItem) {
        var locParts = [selectedItem.floor, selectedItem.location].filter(Boolean);
        loc = locParts.join(' ');
      }
      var desc=document.getElementById('formDesc').value;
      
      if(!itemId){toast('è¨­å‚™ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
      if(!desc){toast('çŠ¶æ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
      
      // å•†å“ãƒ»ç®¡ç†ä¼šç¤¾æƒ…å ±ã‚’å–å¾—
      var itemId = document.getElementById('selectedItemId').value;
      var partnerId = document.getElementById('selectedPartnerId').value;
      var partnerName = document.getElementById('selectedPartnerName').value;

      // ç®¡ç†ä¼šç¤¾æŒ¯ã‚Šåˆ†ã‘ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆææ¡ˆæ›¸3.3æº–æ‹ ï¼‰
      if (!partnerId && typeof resolvePartner === 'function') {
        var currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
        var resolved = resolvePartner(
          { assignedPartnerId: partnerId, assignedPartnerName: partnerName, category: cat },
          currentUser.officeCode || ''
        );
        if (resolved.partnerId) {
          partnerId = resolved.partnerId;
          partnerName = resolved.partnerName;
        }
      }

      saveReport({
        type:type,
        title:title,
        itemId:itemId,  // å•†å“ID
        category:cat,
        priority:priority,
        location:loc,
        description:desc,
        emergency:false,
        assignedPartnerId: partnerId,  // ç®¡ç†ä¼šç¤¾ID
        assignedPartnerName: partnerName,  // ç®¡ç†ä¼šç¤¾å
        photos: attachedPhotos.slice()  // å†™çœŸãƒ‡ãƒ¼ã‚¿
      });
      closeForm();
      clearPhotos();
      logEvent('report_submit', { reportType: type, title: title, category: cat, priority: priority, location: loc, partnerId: partnerId });
      showSentOK(lastSavedReportId || '');
      // ç®¡ç†ä¼šç¤¾å‘ã‘é€šçŸ¥ã‚’ç™ºç”Ÿ
      if (typeof sendNotification === 'function' && partnerId) {
        var urgLabel = priority === 'é«˜' ? 'ã€ç·Šæ€¥ã€‘' : '';
        sendNotification({
          toUserId: partnerId,
          toRole: 'contractor',
          type: 'new_report',
          reportId: lastSavedReportId || '',
          message: urgLabel + 'æ–°ã—ã„é€šå ±ï¼š' + (title||cat) + 'ï¼ˆ' + (loc||'å ´æ‰€æœªè¨˜å…¥') + 'ï¼‰'
        });
      }
      // äº‹æ¥­æ‰€ç®¡ç†è€…å‘ã‘é€šçŸ¥ã‚’ç™ºç”Ÿ
      if (typeof sendNotification === 'function') {
        var urgLabel2 = priority === 'é«˜' ? 'ã€ç·Šæ€¥ã€‘' : '';
        sendNotification({
          toRole: 'office_admin',
          type: 'new_report',
          reportId: lastSavedReportId || '',
          message: urgLabel2 + 'ã‚¹ã‚¿ãƒƒãƒ•ã‹ã‚‰ã®é€šå ±ï¼š' + (title||cat) + 'ï¼ˆ' + (loc||'å ´æ‰€æœªè¨˜å…¥') + 'ï¼‰'
        });
        // æœ¬ç¤¾ç®¡ç†è€…ã«ã‚‚é€šçŸ¥
        sendNotification({
          toRole: 'company_admin',
          type: 'new_report',
          reportId: lastSavedReportId || '',
          message: urgLabel2 + 'æ–°ã—ã„é€šå ±ï¼š' + (title||cat) + 'ï¼ˆ' + (loc||'å ´æ‰€æœªè¨˜å…¥') + 'ï¼‰'
        });
      }
      try{ONE.sendLocalNotify('ã€é€šå ±ã€‘'+cat, 'é€šå ±ãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸ\nå ´æ‰€ï¼š'+(loc||'æœªè¨˜å…¥'), {tag:'report-'+Date.now(), url:'/report.html'});}catch(e){}
      renderHistory();
      // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('formTitleInput').value='';
      document.getElementById('formDesc').value='';
      clearEquipmentSelection();
    }


    // ===== å†™çœŸæ·»ä»˜æ©Ÿèƒ½ =====
    var attachedPhotos = [];
    var MAX_PHOTOS = 3;
    var MAX_WIDTH = 800;

    function handlePhotos(input) {
      var files = Array.from(input.files);
      if (attachedPhotos.length + files.length > MAX_PHOTOS) {
        toast('å†™çœŸã¯æœ€å¤§' + MAX_PHOTOS + 'æšã¾ã§ã§ã™');
        files = files.slice(0, MAX_PHOTOS - attachedPhotos.length);
      }
      files.forEach(function(file) {
        resizeImage(file, function(dataUrl) {
          attachedPhotos.push(dataUrl);
          renderPhotoPreviews();
        });
      });
      input.value = '';
    }

    function resizeImage(file, callback) {
      var reader = new FileReader();
      reader.onload = function(e) {
        var img = new Image();
        img.onload = function() {
          var w = img.width, h = img.height;
          if (w > MAX_WIDTH) { h = Math.round(h * MAX_WIDTH / w); w = MAX_WIDTH; }
          var canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          canvas.getContext('2d').drawImage(img, 0, 0, w, h);
          callback(canvas.toDataURL('image/jpeg', 0.7));
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function renderPhotoPreviews() {
      var container = document.getElementById('photoPreviews');
      container.innerHTML = attachedPhotos.map(function(src, i) {
        return '<div class="photo-thumb"><img src="' + src + '"><button class="remove-photo" onclick="removePhoto(' + i + ')">Ã—</button></div>';
      }).join('');
    }

    function removePhoto(index) {
      attachedPhotos.splice(index, 1);
      renderPhotoPreviews();
    }

    function clearPhotos() {
      attachedPhotos = [];
      renderPhotoPreviews();
    }

    // ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²
    function logEvent(type, detail) {
      try {
        var logs = JSON.parse(demoGetFromLocalStorage('audit.logs') || '[]');
        logs.push({
          timestamp: new Date().toISOString(),
          type: type,
          screen: 'report',
          user: currentUser?.name || '',
          userId: currentUser?.userId || currentUser?.id || '',
          companyCode: currentUser?.companyCode || '',
          details: typeof detail === 'string' ? detail : JSON.stringify(detail)
        });
        demoSaveToLocalStorage('audit.logs', JSON.stringify(logs));
      } catch(e) { console.error('ç›£æŸ»ãƒ­ã‚°ã‚¨ãƒ©ãƒ¼:', e); }
    }

    function saveReport(data){
      // sessionStorageã¨localStorageã®ä¸¡æ–¹ã‹ã‚‰èª­ã¿å–ã‚Šãƒ»ãƒãƒ¼ã‚¸ï¼ˆDEMOå¯¾å¿œï¼‰
      var reportsFromSession = [];
      var reportsFromLocal = [];
      try { reportsFromSession = JSON.parse(sessionStorage.getItem('onetouch.reports') || '[]'); } catch(e) {}
      try { reportsFromLocal = JSON.parse(localStorage.getItem('onetouch.reports') || '[]'); } catch(e) {}
      var reports = [...reportsFromSession];
      reportsFromLocal.forEach(function(r) { if (!reports.find(function(m) { return m.id === r.id; })) reports.push(r); });
      
      // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ï¼ˆsessionStorageã®currentUserã‹ã‚‰ï¼‰
      var currentOfficeCode = currentUser?.officeCode || '';
      var currentOfficeName = currentUser?.officeName || '';
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: currentUserã«äº‹æ¥­æ‰€æƒ…å ±ãŒãªã„å ´åˆã€currentAccountã‚’ç¢ºèª
      if (!currentOfficeName) {
        try {
          const currentAccount = JSON.parse(demoGetFromLocalStorage('currentAccount') || 'null');
          if (currentAccount) {
            currentOfficeCode = currentAccount.officeCode || currentOfficeCode;
            currentOfficeName = currentAccount.officeName || currentOfficeName;
          }
        } catch (e) {
        }
      }
      
      // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
      var now = new Date();
      var dateStr = now.getFullYear() + 
                    String(now.getMonth() + 1).padStart(2, '0') + 
                    String(now.getDate()).padStart(2, '0');
      
      // ä»Šæ—¥ã®é€šå ±æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆåŒã˜æ—¥ä»˜ã®IDã‚’æ¢ã™ï¼‰
      var todayReports = reports.filter(r => r.id && r.id.startsWith('RPT-' + dateStr));
      var seqNum = String(todayReports.length + 1).padStart(3, '0');
      
      // é€šå ±IDã‚’ç”Ÿæˆï¼ˆä¾‹ï¼šRPT-20260205-001ï¼‰
      var reportId = 'RPT-' + dateStr + '-' + seqNum;
      window.lastSavedReportId = reportId;
      
      // ========================================
      // ç®¡ç†ä¼šç¤¾æƒ…å ±ã‚’å•†å“ã‹ã‚‰å–å¾—
      // ========================================
      var assignedPartnerId = data.assignedPartnerId || null;
      var assignedPartnerName = data.assignedPartnerName || null;
      
      
      
      reports.unshift({
        id: reportId,
        userId: currentUser?.userId || '',
        reporter: currentUser?.name || '',
        companyCode: currentUser?.companyCode || 'DEMO',
        officeCode: currentOfficeCode,
        officeName: currentOfficeName,
        timestamp: new Date().toISOString(),
        // ç®¡ç†ä¼šç¤¾æƒ…å ±ï¼ˆæ–°è¦è¿½åŠ ï¼‰
        assignedPartnerId: assignedPartnerId,
        assignedPartnerName: assignedPartnerName,
        assignedAt: assignedPartnerId ? new Date().toISOString() : null,
        contractorStatus: assignedPartnerId ? 'æœªå¯¾å¿œ' : null,
        contractorComments: [],
        statusHistory: assignedPartnerId ? [{
          status: 'æœªå¯¾å¿œ',
          author: 'ã‚·ã‚¹ãƒ†ãƒ ',
          timestamp: new Date().toISOString()
        }] : [],
        ...data
      });
      demoSaveToLocalStorage('onetouch.reports',JSON.stringify(reports));
      ONE.logEvent('report_submit',data.category+' / '+data.type);
    }

    // é€šå ±ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿å–ã‚Šï¼ˆsession+localStorageä¸¡æ–¹ã‹ã‚‰ãƒãƒ¼ã‚¸ï¼‰
    function getAllReports() {
      var reportsFromSession = [];
      var reportsFromLocal = [];
      try { reportsFromSession = JSON.parse(sessionStorage.getItem('onetouch.reports') || '[]'); } catch(e) {}
      try { reportsFromLocal = JSON.parse(localStorage.getItem('onetouch.reports') || '[]'); } catch(e) {}
      var merged = [...reportsFromSession];
      reportsFromLocal.forEach(function(r) { if (!merged.find(function(m) { return m.id === r.id; })) merged.push(r); });
      return merged;
    }

    var currentStatusFilter = 'all';

    function filterByStatus(status, el) {
      currentStatusFilter = status;
      document.querySelectorAll('.status-tab').forEach(function(t){ t.classList.remove('active'); });
      if(el) el.classList.add('active');
      renderHistory();
    }

    function updateStatusCounts(reports) {
      var counts = { all: reports.length, 'æœªå¯¾å¿œ': 0, 'å¯¾å¿œä¸­': 0, 'å®Œäº†': 0, 'å¯¾å¿œä¸å¯': 0 };
      reports.forEach(function(r) {
        var s = r.contractorStatus || 'æœªå¯¾å¿œ';
        if (counts[s] !== undefined) counts[s]++;
      });
      document.getElementById('countAll').textContent = counts.all;
      document.getElementById('countPending').textContent = counts['æœªå¯¾å¿œ'];
      document.getElementById('countProgress').textContent = counts['å¯¾å¿œä¸­'];
      document.getElementById('countComplete').textContent = counts['å®Œäº†'];
      document.getElementById('countUnavailable').textContent = counts['å¯¾å¿œä¸å¯'];
    }

    function renderHistory(){
      var reports=getAllReports();
      
      // åŒã˜äº‹æ¥­æ‰€ã®é€šå ±ã‚’å…¨ä»¶è¡¨ç¤ºï¼ˆäºŒé‡é€šå ±é˜²æ­¢ï¼‰
      const currentOfficeCode = currentUser?.officeCode || '';
      
      reports = reports.filter(function(r) {
        return r.officeCode === currentOfficeCode;
      });

      // ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°ï¼ˆãƒ•ã‚£ãƒ«ã‚¿å‰ï¼‰
      updateStatusCounts(reports);

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿
      if (currentStatusFilter !== 'all') {
        reports = reports.filter(function(r) {
          return (r.contractorStatus || 'æœªå¯¾å¿œ') === currentStatusFilter;
        });
      }
      
      var c=document.getElementById('historyArea');
      if(reports.length===0){
        c.innerHTML='<div style="text-align:center;padding:24px;color:var(--muted);font-size:0.85rem;">é€šå ±å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      // ç®¡ç†ä¼šç¤¾ãƒã‚¹ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆç®¡ç†ä¼šç¤¾åãŒãªã„å ´åˆã«å–å¾—ã™ã‚‹ãŸã‚ï¼‰
      var partners = JSON.parse(demoGetFromLocalStorage('partners') || '[]');
      
      var h='';
      reports.forEach(function(r){
        var d=new Date(r.timestamp);
        var time=d.toLocaleDateString('ja-JP')+' '+d.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'});
        
        // ç®¡ç†ä¼šç¤¾åã‚’å–å¾—ï¼ˆä¿å­˜ã•ã‚Œã¦ã„ãªã„å ´åˆã¯partner-masterã‹ã‚‰å–å¾—ï¼‰
        if (!r.assignedPartnerName && r.assignedPartnerId) {
          var partner = partners.find(function(p) { return p.id === r.assignedPartnerId; });
          if (partner) {
            r.assignedPartnerName = partner.name;
          }
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ï¼ˆã‚¹ã‚¿ãƒƒãƒ•å‘ã‘è¡¨ç¤ºæ–‡è¨€ï¼‰
        var statusClass='status-pending';
        var statusText='å—ä»˜ã—ã¾ã—ãŸ';
        if(r.contractorStatus==='å¯¾å¿œä¸­'){statusClass='status-progress';statusText='å¯¾å¿œã—ã¦ã„ã¾ã™';}
        else if(r.contractorStatus==='å®Œäº†'){statusClass='status-complete';statusText='è§£æ±ºã—ã¾ã—ãŸ';}
        else if(r.contractorStatus==='å¯¾å¿œä¸å¯'){statusClass='status-unavailable';statusText='å¯¾å¿œã§ãã¾ã›ã‚“';}
        
        // æœ€æ–°ã‚³ãƒ¡ãƒ³ãƒˆ
        var latestComment='';
        if(r.contractorComments && r.contractorComments.length>0){
          var lastComment=r.contractorComments[r.contractorComments.length-1];
          latestComment='<div class="history-comment">'+esc(lastComment.text)+'</div>';
        }
        
        // å¯¾å¿œæ™‚é–“
        var durationHtml='';
        if(r.contractorStatus==='å®Œäº†' && r.resolvedAt){
          var duration=calculateDuration(r.timestamp,r.resolvedAt);
          durationHtml='<div class="history-duration">å¯¾å¿œæ™‚é–“: '+duration+'</div>';
        }
        
        h+='<div class="history-card" onclick="showHistoryDetail(\''+r.id+'\')" style="cursor: pointer;">';
        h+='<div class="history-header">';
        h+='<div><div class="history-title">'+(r.title||r.category||'é€šå ±')+'</div>';
        h+='<div class="history-id">'+r.id+'</div></div>';
        h+='<span class="status-badge '+statusClass+'">'+statusText+'</span>';
        h+='</div>';
        h+='<div class="history-info">';
        h+='<span>'+time+'</span>';
        h+='<span>'+(r.location||'-')+'</span>';
        h+='<span>'+r.category+'</span>';
        if(r.reporter){ h+='<span>'+esc(r.reporter)+'</span>'; }
        h+='</div>';
        if(r.assignedPartnerName){
          h+='<div class="history-partner">ç®¡ç†ä¼šç¤¾: '+esc(r.assignedPartnerName)+'</div>';
        } else {
          h+='<div style="font-size:12px;color:#ef4444;margin-bottom:8px;">ç®¡ç†ä¼šç¤¾æœªå‰²å½“</div>';
        }
        h+=latestComment;
        h+=durationHtml;
        h+='<div style="margin-top: 8px; font-size: 12px; color: var(--text-muted); text-align: right;">ã‚¿ãƒƒãƒ—ã§è©³ç´° â†’</div>';
        h+='</div>';
      });
      c.innerHTML=h;
    }
    
    function calculateDuration(start,end){
      var ms=new Date(end)-new Date(start);
      var hours=Math.floor(ms/(1000*60*60));
      var minutes=Math.floor((ms%(1000*60*60))/(1000*60));
      if(hours>0)return hours+'æ™‚é–“'+minutes+'åˆ†';
      return minutes+'åˆ†';
    }
    
    renderHistory();
    
    // ã‚ˆãé€šå ±ã™ã‚‹è¨­å‚™ã‚’æ§‹ç¯‰ï¼ˆé€šå ±å±¥æ­´ã‹ã‚‰é›†è¨ˆï¼‰
    // å±¥æ­´ã‚«ãƒ¼ãƒ‰ã‹ã‚‰è©³ç´°è¡¨ç¤º
    function showHistoryDetail(reportId) {
      var reports = getAllReports();
      var r = reports.find(function(report) { return report.id === reportId; });
      if (!r) return;
      
      var d = new Date(r.timestamp);
      var time = d.toLocaleDateString('ja-JP') + ' ' + d.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
      var label = r.emergency ? 'ç·Šæ€¥é€šå ±' : 'é€šå ±';
      var chipClass = r.emergency ? 'danger' : 'warn';
      
      document.getElementById('detailTitle').innerHTML = label;
      
      var content = '<div class="detail-row">';
      content += '<div class="detail-label">é€šå ±ID</div>';
      content += '<div class="detail-value">' + esc(r.id || '-') + '</div>';
      content += '</div>';
      
      content += '<div class="detail-row">';
      content += '<div class="detail-label">æ—¥æ™‚</div>';
      content += '<div class="detail-value">' + time + '</div>';
      content += '</div>';
      
      if (r.title) {
        content += '<div class="detail-row">';
        content += '<div class="detail-label">è¨­å‚™å</div>';
        content += '<div class="detail-value">' + esc(r.title) + '</div>';
        content += '</div>';
      }
      
      content += '<div class="detail-row">';
      content += '<div class="detail-label">é€šå ±è€…</div>';
      content += '<div class="detail-value">' + esc(r.reporter || '-') + '</div>';
      content += '</div>';
      
      content += '<div class="detail-row">';
      content += '<div class="detail-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼</div>';
      content += '<div class="detail-value">' + esc(r.category || '-') + '</div>';
      content += '</div>';
      
      if (r.location) {
        content += '<div class="detail-row">';
        content += '<div class="detail-label">å ´æ‰€</div>';
        content += '<div class="detail-value">' + esc(r.location) + '</div>';
        content += '</div>';
      }
      
      content += '<div class="detail-row">';
      content += '<div class="detail-label">è©³ç´°å†…å®¹</div>';
      content += '<div class="detail-value detail-desc">' + esc(r.description || '-') + '</div>';
      content += '</div>';
      
      // ç®¡ç†ä¼šç¤¾æƒ…å ±
      content += '<div class="detail-row">';
      content += '<div class="detail-label">å‰²å½“ç®¡ç†ä¼šç¤¾</div>';
      if (r.assignedPartnerName) {
        content += '<div class="detail-value" style="color:#1e40af;font-weight:600;">' + esc(r.assignedPartnerName) + '</div>';
      } else {
        content += '<div class="detail-value" style="color:#ef4444;">ç®¡ç†ä¼šç¤¾æœªå‰²å½“</div>';
      }
      content += '</div>';
      
      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆã‚¹ã‚¿ãƒƒãƒ•å‘ã‘è¡¨ç¤ºæ–‡è¨€ï¼‰
      var staffStatusLabels = {'æœªå¯¾å¿œ':'å—ä»˜ã—ã¾ã—ãŸ','å¯¾å¿œä¸­':'å¯¾å¿œã—ã¦ã„ã¾ã™','å®Œäº†':'è§£æ±ºã—ã¾ã—ãŸ','å¯¾å¿œä¸å¯':'å¯¾å¿œã§ãã¾ã›ã‚“'};
      if (r.contractorStatus) {
        content += '<div class="detail-row">';
        content += '<div class="detail-label">çŠ¶æ³</div>';
        var statusClass = r.contractorStatus === 'æœªå¯¾å¿œ' ? 'status-pending' :
                         r.contractorStatus === 'å¯¾å¿œä¸­' ? 'status-progress' :
                         r.contractorStatus === 'å®Œäº†' ? 'status-complete' : 'status-unavailable';
        content += '<div class="detail-value"><span class="status-badge ' + statusClass + '">' + (staffStatusLabels[r.contractorStatus] || r.contractorStatus) + '</span></div>';
        content += '</div>';
      }
      
      // å¯¾å¿œæ™‚é–“
      if (r.contractorStatus === 'å®Œäº†' && r.resolvedAt) {
        content += '<div class="detail-row">';
        content += '<div class="detail-label">å¯¾å¿œæ™‚é–“</div>';
        var duration = calculateDuration(r.timestamp, r.resolvedAt);
        content += '<div class="detail-value">' + duration + '</div>';
        content += '</div>';
      }
      
      // å¯¾å¿œå±¥æ­´ï¼ˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼‰
      var history = r.statusHistory || [];
      if (history.length > 0) {
        content += '<div class="detail-row">';
        content += '<div class="detail-label">å¯¾å¿œå±¥æ­´</div>';
        content += '<div class="timeline">';
        history.forEach(function(entry) {
          var d = new Date(entry.timestamp);
          var dateStr = (d.getMonth()+1) + '/' + d.getDate();
          var timeStr = String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
          var isComment = entry.type === 'comment';
          var dotClass = 'timeline-dot';
          if (!isComment) {
            dotClass += ' status-change';
            if (entry.status === 'æœªå¯¾å¿œ') dotClass += ' st-pending';
            else if (entry.status === 'å¯¾å¿œä¸­') dotClass += ' st-progress';
            else if (entry.status === 'å®Œäº†') dotClass += ' st-complete';
            else if (entry.status === 'å¯¾å¿œä¸å¯') dotClass += ' st-unavailable';
          }
          content += '<div class="timeline-item">';
          content += '<div class="timeline-left"><div class="timeline-date">' + dateStr + '<br>' + timeStr + '</div></div>';
          content += '<div class="timeline-dot-line"><div class="' + dotClass + '"></div><div class="timeline-line"></div></div>';
          content += '<div class="timeline-content">';
          if (!isComment) content += '<div class="timeline-status">' + esc(staffStatusLabels[entry.status] || entry.status || '') + '</div>';
          if (entry.comment) content += '<div class="timeline-comment">' + esc(entry.comment) + '</div>';
          content += '</div></div>';
        });
        content += '</div>';
        content += '</div>';
      }
      
      // æ·»ä»˜å†™çœŸ
      if (r.photos && r.photos.length > 0) {
        content += '<div class="detail-row">';
        content += '<div class="detail-label">æ·»ä»˜å†™çœŸ</div>';
        content += '<div class="detail-photos">';
        r.photos.forEach(function(src) {
          content += '<img src="' + src + '" onclick="window.open(this.src)">';
        });
        content += '</div>';
        content += '</div>';
      }
      
      document.getElementById('detailContent').innerHTML = content;
      document.body._scrollY=window.scrollY;
      document.body.style.top=(-window.scrollY)+'px';
      document.body.classList.add('modal-open');
      document.getElementById('detailOverlay').classList.add('open');
    }

    function showDetail(idx){
      var reports=getAllReports();
      var r=reports[idx];
      if(!r)return;
      
      var d=new Date(r.timestamp);
      var time=d.toLocaleDateString('ja-JP')+' '+d.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
      var label=r.emergency?'ç·Šæ€¥é€šå ±':'é€šå ±';
      var chipClass=r.emergency?'danger':'warn';
      
      document.getElementById('detailTitle').innerHTML=label;
      
      var content='<div class="detail-row">';
      content+='<div class="detail-label">é€šå ±ID</div>';
      content+='<div class="detail-value">'+esc(r.id||'-')+'</div>';
      content+='</div>';
      
      content+='<div class="detail-row">';
      content+='<div class="detail-label">æ—¥æ™‚</div>';
      content+='<div class="detail-value">'+time+'</div>';
      content+='</div>';
      
      content+='<div class="detail-row">';
      content+='<div class="detail-label">ç¨®åˆ¥</div>';
      content+='<div class="detail-value"><span class="chip '+chipClass+'">'+(r.emergency?'ç·Šæ€¥':'é€šå ±')+'</span></div>';
      content+='</div>';
      
      content+='<div class="detail-row">';
      content+='<div class="detail-label">é€šå ±è€…</div>';
      content+='<div class="detail-value">'+esc(r.reporter||'-')+'</div>';
      content+='</div>';
      
      content+='<div class="detail-row">';
      content+='<div class="detail-label">å¯¾è±¡ç®¡ç†ä¼šç¤¾</div>';
      content+='<div class="detail-value">'+esc(typeLabels[r.type]||r.type||'-')+'</div>';
      content+='</div>';
      
      content+='<div class="detail-row">';
      content+='<div class="detail-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼</div>';
      content+='<div class="detail-value">'+esc(r.category||'-')+'</div>';
      content+='</div>';
      
      if(r.location){
        content+='<div class="detail-row">';
        content+='<div class="detail-label">å ´æ‰€</div>';
        content+='<div class="detail-value">'+esc(r.location)+'</div>';
        content+='</div>';
      }
      
      content+='<div class="detail-row">';
      content+='<div class="detail-label">è©³ç´°å†…å®¹</div>';
      content+='<div class="detail-value detail-desc">'+esc(r.description||'-')+'</div>';
      content+='</div>';
      
      content+='<div class="detail-row">';
      content+='<div class="detail-label">çŠ¶æ…‹</div>';
      content+='<div class="detail-value"><span class="chip ok">é€ä¿¡æ¸ˆ</span></div>';
      content+='</div>';
      
      document.getElementById('detailContent').innerHTML=content;
      document.body._scrollY=window.scrollY;
      document.body.style.top=(-window.scrollY)+'px';
      document.body.classList.add('modal-open');
      document.getElementById('detailOverlay').classList.add('open');
    }

    function closeDetail(){
      document.body.classList.remove('modal-open');
      document.body.style.top='';
      window.scrollTo(0,document.body._scrollY||0);
      document.getElementById('detailOverlay').classList.remove('open');
    }

    function toast(msg){
      var t=document.getElementById('toast');
      t.textContent=msg;
      t.classList.add('show');
      setTimeout(function(){t.classList.remove('show');},2500);
    }

    function showSentOK(reportId){
      var ov=document.createElement('div');
      ov.className='sent-ok';
      ov.innerHTML='<div class="sent-ok-card">'
        +'<div class="sent-ok-icon">âœ“</div>'
        +'<div class="sent-ok-title">é€ä¿¡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ</div>'
        +(reportId ? '<div style="font-size:14px;color:#94a3b8;margin-bottom:8px;">å—ä»˜ç•ªå·ï¼š'+esc(reportId)+'</div>' : '')
        +'<div class="sent-ok-sub">å†…å®¹ã¯è‡ªå‹•ã§æ‹…å½“è€…ã«å±Šã„ã¦ã„ã¾ã™ã€‚<br>æ–½è¨­ç®¡ç†è€…ã¸ã®å€‹åˆ¥é€£çµ¡ã¯ä¸è¦ã§ã™ã€‚</div>'
        +'<div style="display:flex;flex-direction:column;gap:10px;margin-top:24px;">'
        +'<button onclick="this.closest(\'.sent-ok\').remove();document.getElementById(\'historyArea\').scrollIntoView({behavior:\'smooth\'});" style="padding:14px 24px;background:#1e3a5f;color:white;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;min-height:50px;">å±¥æ­´ã‚’è¦‹ã‚‹</button>'
        +'<button onclick="this.closest(\'.sent-ok\').remove();" style="padding:14px 24px;background:#f0f0f0;color:#333;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;min-height:50px;">ã‚‚ã†ä¸€ä»¶é€ã‚‹</button>'
        +'</div>'
        +'</div>';
      document.body.appendChild(ov);
    }

    // ========== éŸ³å£°å…¥åŠ› ==========
    var _voiceRecognition = null;
    var _voiceTargetId = null;
    var _voiceActive = false;

    function startVoice(targetId) {
      var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        toast('ã“ã®ç«¯æœ«ã§ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
        return;
      }

      // æ—¢ã«éŒ²éŸ³ä¸­ãªã‚‰åœæ­¢
      if (_voiceActive && _voiceRecognition) {
        _voiceRecognition.stop();
        return;
      }

      _voiceTargetId = targetId;
      _voiceRecognition = new SpeechRecognition();
      _voiceRecognition.lang = 'ja-JP';
      _voiceRecognition.interimResults = true;
      _voiceRecognition.continuous = false;
      _voiceRecognition.maxAlternatives = 1;

      var targetEl = document.getElementById(targetId);
      var btnId = targetId === 'equipmentSearch' ? 'voiceSearchBtn' : 'voiceDescBtn';
      var btn = document.getElementById(btnId);
      var originalValue = targetEl.value;

      // UI: éŒ²éŸ³ä¸­è¡¨ç¤º
      _voiceActive = true;
      btn.style.background = '#fee2e2';
      btn.querySelector('svg').setAttribute('stroke', '#ef4444');
      targetEl.placeholder = 'è©±ã—ã¦ãã ã•ã„...';
      targetEl.style.borderColor = '#ef4444';
      targetEl.style.boxShadow = '0 0 0 3px rgba(239,68,68,0.15)';

      _voiceRecognition.onresult = function(event) {
        var transcript = '';
        for (var i = event.resultIndex; i < event.results.length; i++) {
          transcript += event.results[i][0].transcript;
        }
        if (targetId === 'formDesc') {
          targetEl.value = originalValue + (originalValue ? '' : '') + transcript;
          // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
          var countEl = document.getElementById('formDescCount');
          if (countEl) countEl.textContent = targetEl.value.length + '/200';
        } else {
          targetEl.value = transcript;
          // æ¤œç´¢å€™è£œã‚’è¡¨ç¤º
          showSuggestions();
        }
      };

      _voiceRecognition.onend = function() {
        _voiceActive = false;
        btn.style.background = 'none';
        btn.querySelector('svg').setAttribute('stroke', '#888');
        targetEl.placeholder = targetId === 'equipmentSearch' ? 'è¨­å‚™åãƒ»å‹ç•ªãƒ»ãƒ¡ãƒ¼ã‚«ãƒ¼ã§æ¤œç´¢' : 'ä¾‹ï¼š3éšå»Šä¸‹ã®ã‚¨ã‚¢ã‚³ãƒ³ãŒå‹•ãã¾ã›ã‚“';
        targetEl.style.borderColor = '#ddd';
        targetEl.style.boxShadow = 'none';
      };

      _voiceRecognition.onerror = function(event) {
        _voiceActive = false;
        btn.style.background = 'none';
        btn.querySelector('svg').setAttribute('stroke', '#888');
        targetEl.style.borderColor = '#ddd';
        targetEl.style.boxShadow = 'none';
        if (event.error === 'not-allowed') {
          toast('ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç«¯æœ«ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
        } else if (event.error !== 'aborted' && event.error !== 'no-speech') {
          toast('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ' + event.error);
        }
        targetEl.placeholder = targetId === 'equipmentSearch' ? 'è¨­å‚™åãƒ»å‹ç•ªãƒ»ãƒ¡ãƒ¼ã‚«ãƒ¼ã§æ¤œç´¢' : 'ä¾‹ï¼š3éšå»Šä¸‹ã®ã‚¨ã‚¢ã‚³ãƒ³ãŒå‹•ãã¾ã›ã‚“';
      };

      _voiceRecognition.start();
    }

  </script>
</body>
</html>
